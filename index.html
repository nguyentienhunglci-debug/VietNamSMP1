<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tr·ª£ L√Ω C√° Nh√¢n</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

    <link rel="icon" type="image/png" href="https://cdn.discordapp.com/attachments/1375475716371775499/1467762343151669288/IMG_5241.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">

    <style>
        /* =================================================================
           CSS C∆† B·∫¢N
           ================================================================= */
        :root { --bg-primary: #111111; --bg-secondary: #1c1c1e; --card-bg: #1c1c1e; --text-primary: #f5f5f7; --text-secondary: #8e8e93; --accent-primary: #0a84ff; --accent-red: #ff453a; --accent-green: #30d158; --accent-orange: #ff9f0a; --border-color: #38383a; --font-family: 'Quicksand', sans-serif; }
        html.light-theme { --bg-primary: #f2f2f7; --bg-secondary: #ffffff; --card-bg: #ffffff; --text-primary: #000000; --text-secondary: #636366; --accent-primary: #007aff; --border-color: #e5e5ea; }
        html.kitty-theme { --bg-primary: #fff0f5; --bg-secondary: #ffffff; --card-bg: rgba(255, 255, 255, 0.9); --text-primary: #5c3c54; --text-secondary: #d17fb4; --accent-primary: #ff85a2; --accent-red: #f75d72; --accent-green: #61d3a3; --accent-orange: #ffb480; --border-color: #f7d6e0; --font-family: 'Quicksand', cursive; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { color-scheme: dark; scroll-behavior: smooth; }
        html.light-theme, html.kitty-theme { color-scheme: light; }
        body { font-family: var(--font-family); background-color: var(--bg-primary); color: var(--text-primary); padding-bottom: 120px; min-height: 100vh; transition: background-color 0.3s ease, color 0.3s ease; }
        html.kitty-theme body { background-image: url('https://i.pinimg.com/originals/a8/60/a3/a860a340a2353a2f7334f64797a7a42b.jpg'); background-size: cover; background-position: center center; background-attachment: fixed; }
        
        .screen { display: none; padding: 70px 16px 20px 16px; animation: fadeIn 0.4s ease; position: relative; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .screen.active { display: block; }
        .screen-title-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding: 0 4px; }
        .screen-title-bar h2 { font-size: 38px; font-weight: 700; color: var(--text-primary); }
        
        /* BOTTOM NAV */
        .bottom-nav { position: fixed; bottom: calc(15px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%); width: calc(100% - 32px); max-width: 450px; background-color: rgba(28, 28, 30, 0.75); backdrop-filter: blur(20px); border: 1px solid var(--border-color); border-radius: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); display: flex; padding: 6px; z-index: 1000; }
        html.light-theme .bottom-nav { background-color: rgba(248, 248, 248, 0.75); } html.kitty-theme .bottom-nav { background-color: rgba(255, 230, 240, 0.8); }
        .nav-item { flex: 1; text-align: center; padding: 10px 0 8px 0; cursor: pointer; color: var(--text-secondary); transition: color 0.3s ease, transform 0.15s ease; z-index: 1; }
        .nav-item.active { color: var(--accent-primary); }
        .nav-item .nav-icon { width: 24px; height: 24px; margin: 0 auto 4px auto; stroke-width: 2; }
        .nav-item .nav-label { font-size: 11px; font-weight: 600; }
        #nav-active-bubble { position: absolute; top: 6px; height: calc(100% - 12px); background-color: var(--bg-secondary); border-radius: 24px; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 0; }
        html.light-theme #nav-active-bubble, html.kitty-theme #nav-active-bubble { background-color: #ffffff; border: 1px solid var(--border-color); }

        /* GENERAL UI ELEMENTS */
        .btn { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 20px; border: none; border-radius: 10px; font-size: 17px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 16px; background-color: var(--accent-primary); color: white; font-family: var(--font-family); }
        .btn:active { opacity: 0.8; transform: scale(0.97); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-sec { background-color: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-danger { background-color: var(--accent-red); }
        .btn-small { padding: 8px 14px; font-size: 14px; }
        .card { background-color: var(--card-bg); border-radius: 12px; padding: 20px; margin-bottom: 16px; border: 1px solid var(--border-color); backdrop-filter: blur(10px); }
        .data-card { background-color: var(--card-bg); border-radius: 12px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--border-color); }
        .data-title { font-size: 20px; font-weight: 600; }
        .data-subtitle { font-size: 14px; color: var(--text-secondary); }
        .data-btn { background-color: var(--bg-secondary); color: var(--text-primary); padding: 8px 16px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 14px; font-weight: 600; cursor: pointer; }
        .data-btn.delete { color: var(--accent-red); }

        /* MODAL */
        .modal { display: flex; align-items: flex-end; justify-content: center; position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.4); z-index: 2000; opacity: 0; pointer-events: none; transition: 0.4s; backdrop-filter: blur(5px); }
        .modal.show { opacity: 1; pointer-events: auto; }
        .modal-content { background-color: var(--bg-secondary); border-radius: 18px 18px 0 0; padding: 24px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border-color); transform: translateY(100%); transition: 0.4s cubic-bezier(0.2, 0.9, 0.3, 1); padding-bottom: calc(24px + env(safe-area-inset-bottom)); }
        .modal.show .modal-content { transform: translateY(0); }
        @media (min-width: 600px) { .modal { align-items: center; } .modal-content { width: 92%; max-width: 440px; border-radius: 18px; transform: translateY(20px) scale(0.95); } .modal.show .modal-content { transform: translateY(0) scale(1); } }
        .modal-title { font-size: 26px; font-weight: 700; margin-bottom: 24px; }
        .modal-actions { display: flex; gap: 12px; margin-top: 24px; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; color: var(--text-secondary); font-size: 16px; margin-bottom: 8px; font-weight: 600; }
        .form-input, .form-select, .form-textarea { background-color: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color); width: 100%; padding: 14px; border-radius: 10px; font-size: 17px; font-family: inherit; }
        .form-textarea { min-height: 120px; }
        .copy-toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background-color: #2c2c2e; color: #f5f5f7; padding: 12px 24px; border-radius: 25px; z-index: 3000; font-size: 14px; font-weight: 600; opacity: 0; transition: 0.3s; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .copy-toast.show { opacity: 1; transform: translate(-50%, -10px); }
        
        /* SCHEDULE & FINANCE */
        #clock-time { font-size: 56px; font-weight: 700; text-align: center; }
        #clock-date { font-size: 17px; color: var(--text-secondary); text-align: center; margin-bottom: 30px; }
        .schedule-item { background-color: var(--card-bg); border: 1px solid var(--border-color); padding: 16px 20px; border-radius: 12px; margin-bottom: 12px; font-size: 17px; font-weight: 600; border-left: 5px solid var(--accent-green); display: flex; justify-content: space-between; align-items: center; }
        .schedule-item-off { border-left-color: var(--accent-orange); }
        .schedule-item span { font-size: 13px; font-weight: 600; padding: 5px 12px; border-radius: 20px; background-color: var(--bg-primary); color: var(--text-secondary); border: 1px solid var(--border-color); min-width: 60px; text-align: center; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .stat-card { background-color: var(--bg-primary); padding: 16px; border-radius: 10px; text-align: left; border: 1px solid var(--border-color); }
        .stat-card.full-width { grid-column: 1 / -1; }
        .stat-value { font-size: 26px; font-weight: 700; }
        .stat-value.red { color: var(--accent-red); } .stat-value.green { color: var(--accent-green); }
        .txn-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 4px; border-bottom: 1px solid var(--border-color); }
        .txn-amount { font-size: 16px; font-weight: 600; }
        .password-value-container { background-color: var(--bg-primary); padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 16px; font-family: monospace; margin-bottom: 12px; }
        .toggle-switch { width: 50px; height: 30px; background-color: var(--bg-primary); border-radius: 15px; position: relative; border: 1px solid var(--border-color); }
        .toggle-knob { width: 24px; height: 24px; background-color: white; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: 0.3s; }
        .toggle-switch.active { background-color: var(--accent-green); border-color: var(--accent-green); }
        .toggle-switch.active .toggle-knob { transform: translateX(20px); }
        
        /* HELLO KITTY */
        #kitty-transition-overlay { position: fixed; inset: 0; background-color: #111; z-index: 9999; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.5s; pointer-events: none; }
        #kitty-transition-overlay.show { display: flex; pointer-events: auto; }
        #kitty-logo { font-family: 'Pacifico', cursive; font-size: 15vw; color: #ff85a2; opacity: 0; transform: scale(0.8); transition: 1.5s; }
        #kitty-logo.show { opacity: 1; transform: scale(1); }
        #kitty-float-container { position: fixed; inset: 0; z-index: -1; pointer-events: none; overflow: hidden; display: none; }
        html.kitty-theme #kitty-float-container { display: block; }
        .floating-kitty { position: absolute; left: -100px; opacity: 0.7; animation: floatAcross linear infinite; }
        @keyframes floatAcross { 0% { transform: translateX(0) rotate(0deg); left: -100px; } 100% { transform: translateX(100vw) rotate(360deg); left: 100vw; } }

        /* COMMUNITY & AUTH */
        .post-input-container { background: var(--card-bg); border-radius: 12px; padding: 16px; border: 1px solid var(--border-color); margin-bottom: 20px; cursor: pointer; }
        .post-input-header { display: flex; align-items: center; gap: 10px; }
        .user-avatar-small { width: 36px; height: 36px; border-radius: 50%; background: var(--accent-primary); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; }
        .post-input-fake { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 20px; padding: 10px 15px; color: var(--text-secondary); font-size: 15px; width: 100%; }
        .post-card { background: var(--card-bg); border-radius: 12px; padding: 16px; border: 1px solid var(--border-color); margin-bottom: 16px; }
        .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .post-author-name { font-weight: 700; font-size: 16px; }
        .post-time { font-size: 12px; color: var(--text-secondary); }
        .post-content { font-size: 16px; line-height: 1.5; margin-bottom: 12px; white-space: pre-wrap; }
        .post-actions { border-top: 1px solid var(--border-color); padding-top: 10px; display: flex; gap: 20px; }
        .action-btn { background: none; border: none; color: var(--text-secondary); font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 6px; cursor: pointer; font-family: var(--font-family); }
        .action-btn:hover { color: var(--accent-primary); }
        .auth-status-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; text-align: center; margin-bottom: 16px; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; margin-bottom: 10px; }
        .status-offline { background: #3a3a3c; color: #8e8e93; }
        .status-online { background: rgba(48, 209, 88, 0.2); color: #30d158; border: 1px solid #30d158; }

        /* ============================
           CHAT BUBBLE (N√ÇNG C·∫§P)
           ============================ */
        #notification-bell { position: fixed; top: 15px; right: 20px; z-index: 2000; color: var(--text-primary); cursor: pointer; }
        #notif-badge { position: absolute; top: -2px; right: -2px; background: var(--accent-red); color: white; border-radius: 50%; width: 10px; height: 10px; display: none; }
        #notif-badge.active { display: block; }

        #chat-bubble-container { position: fixed; bottom: 100px; right: 16px; width: 350px; height: 550px; border-radius: 18px; background-color: var(--bg-secondary); box-shadow: 0 8px 30px rgba(0,0,0,0.3); overflow: hidden; z-index: 2500; display: flex; flex-direction: column; border: 1px solid var(--border-color); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: bottom right; }
        #chat-bubble-container.minimized { width: 60px; height: 60px; border-radius: 50%; cursor: pointer; }
        #chat-bubble-container.hidden { display: none; }
        
        .chat-header { padding: 12px 16px; background: var(--card-bg); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .chat-title { font-weight: 700; font-size: 16px; display:flex; align-items:center; gap:8px; }
        .chat-back-btn { background:none; border:none; color:var(--text-primary); cursor:pointer; font-size:18px; display:none; }
        .chat-controls button { background: none; border: none; color: var(--text-secondary); font-size: 18px; cursor: pointer; margin-left: 10px; }

        /* VIEW: USER LIST */
        #chat-user-list { flex: 1; overflow-y: auto; padding: 10px; background: var(--bg-primary); display: block; }
        .chat-user-item { display: flex; align-items: center; padding: 10px; border-radius: 10px; cursor: pointer; background: var(--card-bg); margin-bottom: 8px; border: 1px solid var(--border-color); transition: 0.2s; }
        .chat-user-item:hover { background: var(--border-color); }
        .chat-user-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--accent-primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 12px; position: relative; }
        .chat-user-status-dot { width: 12px; height: 12px; border-radius: 50%; background: #555; position: absolute; bottom: 0; right: 0; border: 2px solid var(--card-bg); }
        .chat-user-status-dot.online { background: var(--accent-green); }
        .chat-user-info h4 { font-size: 14px; margin: 0 0 2px 0; }
        .chat-user-info p { font-size: 12px; color: var(--text-secondary); margin: 0; }

        /* VIEW: CONVERSATION */
        #chat-conversation { flex: 1; display: none; flex-direction: column; background: var(--bg-primary); height: 100%; }
        #chat-messages-area { flex: 1; padding: 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .chat-msg { max-width: 80%; padding: 8px 12px; border-radius: 16px; font-size: 14px; line-height: 1.4; position: relative; word-wrap: break-word; }
        .chat-msg.me { align-self: flex-end; background: var(--accent-primary); color: white; border-bottom-right-radius: 4px; }
        .chat-msg.other { align-self: flex-start; background: var(--card-bg); border: 1px solid var(--border-color); border-bottom-left-radius: 4px; }

        .chat-input-bar { padding: 10px; background: var(--card-bg); border-top: 1px solid var(--border-color); display: flex; gap: 8px; }
        .chat-input { flex: 1; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 20px; padding: 8px 14px; color: var(--text-primary); outline: none; }
        .chat-send-btn { background: var(--accent-primary); color: white; border: none; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        
        #chat-toggle-btn { position: fixed; bottom: 100px; right: 16px; background-color: var(--accent-primary); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; z-index: 2400; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }

        #chat-bubble-container.minimized #chat-user-list,
        #chat-bubble-container.minimized #chat-conversation,
        #chat-bubble-container.minimized .chat-header { display: none !important; }
        #chat-bubble-container.minimized::after { content: 'üí¨'; font-size: 24px; display: flex; align-items: center; justify-content: center; height: 100%; width: 100%; }

    </style>
</head>
<body>

<div id="kitty-float-container"></div>
<div id="kitty-transition-overlay"><h1 id="kitty-logo">Hello Kitty</h1></div>

<div id="notification-bell" onclick="showToast('Ki·ªÉm tra tin nh·∫Øn ho·∫∑c b√†i vi·∫øt m·ªõi!')">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 28px; height: 28px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
    <div id="notif-badge"></div>
</div>

<div class="main-container">
    <div id="schedule" class="screen active">
        <div class="screen-title-bar"><h2>L·ªãch tr√¨nh</h2></div>
        <div id="schedule-container">
            <div id="clock-time">--:--:--</div>
            <div id="clock-date">---, --/--/----</div>
            <div id="today-schedule"></div>
            <div id="tomorrow-details-container" style="display:none; animation: fadeIn 0.4s ease; margin-top: -10px;"></div>
            <div id="future-schedule"></div>
        </div>
    </div>

    <div id="finance" class="screen">
        <div class="screen-title-bar"><h2>T√†i ch√≠nh</h2></div>
        <div class="card">
             <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                 <h3 style="margin: 0;">T·ªïng quan</h3>
                 <button class="btn btn-small btn-sec" style="margin: 0;" onclick="showLastMonthSummary()">Th√°ng tr∆∞·ªõc</button>
             </div>
            <div class="stat-grid">
                <div class="stat-card full-width"><div class="stat-label">S·ªë d∆∞</div><div class="stat-value" id="bal">0‚Ç´</div></div>
                <div class="stat-card"><div class="stat-label">ƒê√£ chi</div><div class="stat-value red" id="exp">0‚Ç´</div></div>
                <div class="stat-card"><div class="stat-label">Thu nh·∫≠p</div><div class="stat-value green" id="inc">0‚Ç´</div></div>
            </div>
            <div class="finance-actions" style="margin-top:20px; display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button class="btn btn-danger" style="margin:0;" onclick="openTxn('expense')">Chi ti√™u</button>
                <button class="btn" style="margin:0; background-color: var(--accent-green);" onclick="openTxn('income')">Thu nh·∫≠p</button>
            </div>
        </div>
        <div class="card">
            <h3>L·ªãch s·ª≠ (Th√°ng n√†y)</h3>
            <div id="histList"></div>
        </div>
    </div>

    <div id="community" class="screen">
        <div class="screen-title-bar"><h2>C·ªông ƒë·ªìng</h2></div>
        <div class="post-input-container" onclick="openCreatePost()">
            <div class="post-input-header">
                <div class="user-avatar-small" id="myAvatar">?</div>
                <div class="post-input-fake">B·∫°n ƒëang th·∫Øc m·∫Øc g√¨?</div>
            </div>
        </div>
        <div id="postsList"><p style="text-align:center; color:var(--text-secondary); padding:20px;">ƒêang t·∫£i b√†i vi·∫øt...</p></div>
    </div>

    <div id="passwords" class="screen">
        <div class="screen-title-bar"><h2>M·∫≠t kh·∫©u</h2><button class="btn btn-small" onclick="openPasswordModal()">+ Th√™m</button></div>
        <div id="passwordsList"></div>
    </div>

    <div id="settings" class="screen">
        <div class="screen-title-bar"><h2>C√†i ƒë·∫∑t</h2></div>
        <div class="auth-status-card">
            <div id="authStatusText" class="status-badge status-offline">Ch∆∞a ƒëƒÉng nh·∫≠p</div>
            <h3 id="authEmailDisplay" style="margin-bottom: 10px;">Kh√°ch</h3>
            <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 15px;">ƒêƒÉng nh·∫≠p ƒë·ªÉ hi·ªÉn th·ªã trong danh s√°ch chat.</p>
            <button class="btn" id="btnLoginNav" onclick="openAuthModal('login')">ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω</button>
            <button class="btn btn-danger" id="btnLogoutNav" style="display:none;" onclick="handleLogout()">ƒêƒÉng xu·∫•t</button>
        </div>
        <div class="card">
            <h3>Giao di·ªán</h3>
            <div class="setting-item" style="display:flex;justify-content:space-between;padding:15px 0;border-bottom:1px solid var(--border-color)">
                <span>Ch·∫ø ƒë·ªô s√°ng/t·ªëi</span>
                <div class="toggle-switch" id="theme-toggle" onclick="toggleTheme()"><div class="toggle-knob"></div></div>
            </div>
            <div class="setting-item" style="display:flex;justify-content:space-between;padding:15px 0;">
                <span>Hello Kitty Mode</span>
                <div class="toggle-switch" id="kitty-theme-toggle" onclick="toggleKittyTheme()"><div class="toggle-knob"></div></div>
            </div>
        </div>
        <div class="card">
            <h3>Qu·∫£n l√Ω d·ªØ li·ªáu</h3>
            <button class="btn btn-danger" onclick="resetData()">X√≥a d·ªØ li·ªáu c√° nh√¢n</button>
            <button class="btn btn-sec" onclick="window.location.reload()">C·∫≠p nh·∫≠t phi√™n b·∫£n</button>
        </div>
    </div>

    <div class="bottom-nav">
        <div id="nav-active-bubble"></div>
        <div class="nav-item active" onclick="goTo('schedule', this)">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><div class="nav-label">L·ªãch tr√¨nh</div>
        </div>
        <div class="nav-item" onclick="goTo('finance', this)">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg><div class="nav-label">T√†i ch√≠nh</div>
        </div>
        <div class="nav-item" onclick="goTo('community', this)">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg><div class="nav-label">C·ªông ƒë·ªìng</div>
        </div>
        <div class="nav-item" onclick="goTo('passwords', this)">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.629 5.629l-2.371 2.371a2.121 2.121 0 01-3 0l-1.371-1.371a2.121 2.121 0 010-3l2.371-2.371A6 6 0 0121 9z"></path></svg><div class="nav-label">M·∫≠t kh·∫©u</div>
        </div>
        <div class="nav-item" onclick="goTo('settings', this)">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg><div class="nav-label">C√†i ƒë·∫∑t</div>
        </div>
    </div>
</div>

<div id="chat-bubble-container" class="hidden">
    <div class="chat-header">
        <div class="chat-title">
            <button id="chatBackBtn" class="chat-back-btn" onclick="backToUserList()">‚¨Ö</button>
            <span id="chatTitleText">Th√†nh vi√™n</span>
        </div>
        <div class="chat-controls">
            <button onclick="toggleMinimizeChat()">_</button>
            <button onclick="toggleChatBubble()">√ó</button>
        </div>
    </div>
    
    <div id="chat-user-list">
        <div style="text-align:center; padding:10px; font-size:12px; color:var(--text-secondary);">ƒêang t·∫£i danh s√°ch th√†nh vi√™n...</div>
    </div>

    <div id="chat-conversation">
        <div id="chat-messages-area"></div>
        <div class="chat-input-bar">
            <input type="text" id="chatInput" class="chat-input" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeypress="handleChatEnter(event)">
            <button class="chat-send-btn" onclick="sendChatMessage()">‚û§</button>
        </div>
    </div>
</div>
<button id="chat-toggle-btn" onclick="toggleChatBubble()">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 24px; height: 24px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
</button>

<div id="txnModal" class="modal"><div class="modal-content"><h2 class="modal-title" id="modalTitle"></h2><div class="form-group"><label class="form-label">S·ªë ti·ªÅn (‚Ç´)</label><input type="text" class="form-input" id="amt" placeholder="50000" inputmode="numeric"></div><div class="form-group"><label class="form-label">Danh m·ª•c</label><select class="form-select" id="cat"><option value="ƒÇn u·ªëng">ƒÇn u·ªëng</option><option value="ƒêi l·∫°i">ƒêi l·∫°i</option><option value="Mua s·∫Øm">Mua s·∫Øm</option><option value="H√≥a ƒë∆°n">H√≥a ƒë∆°n</option><option value="L∆∞∆°ng">L∆∞∆°ng</option><option value="Gi·∫£i tr√≠">Gi·∫£i tr√≠</option><option value="Kh√°c">Kh√°c</option></select></div><div class="form-group"><label class="form-label">Ghi ch√∫</label><textarea class="form-textarea" id="note" placeholder="..."></textarea></div><input type="hidden" id="type"><div class="modal-actions"><button class="btn btn-sec" onclick="closeModal('txnModal')" style="flex:1; margin:0;">H·ªßy</button><button class="btn" onclick="saveTxn()" style="flex:1; margin:0;">L∆∞u</button></div></div></div>
<div id="passwordModal" class="modal"><div class="modal-content"><h2 class="modal-title" id="passwordModalTitle"></h2><div class="form-group"><label class="form-label">T√™n d·ªãch v·ª•</label><input type="text" class="form-input" id="passwordService"></div><div class="form-group"><label class="form-label">T√™n ƒëƒÉng nh·∫≠p</label><input type="text" class="form-input" id="passwordUsername"></div><div class="form-group"><label class="form-label">M·∫≠t kh·∫©u</label><input type="password" class="form-input" id="passwordValue"></div><input type="hidden" id="editPasswordId"><div class="modal-actions"><button class="btn btn-sec" onclick="closeModal('passwordModal')" style="flex:1; margin:0;">H·ªßy</button><button class="btn" onclick="savePassword()" style="flex:1; margin:0;">L∆∞u</button></div></div></div>
<div id="summaryModal" class="modal"><div class="modal-content"><h2 class="modal-title">Th·ªëng k√™ th√°ng tr∆∞·ªõc</h2><div id="summaryContent" style="max-height: 50vh; overflow-y: auto;"></div><div class="modal-actions"><button class="btn" onclick="closeModal('summaryModal')" style="flex:1; margin:0;">ƒê√≥ng</button></div></div></div>
<div id="postModal" class="modal"><div class="modal-content"><h2 class="modal-title">T·∫°o b√†i vi·∫øt</h2><div class="form-group"><textarea class="form-textarea" id="postContent" placeholder="B·∫°n ƒëang th·∫Øc m·∫Øc g√¨? Chia s·∫ª v·ªõi c·ªông ƒë·ªìng ngay..."></textarea></div><div class="modal-actions"><button class="btn btn-sec" onclick="closeModal('postModal')" style="flex:1;">H·ªßy</button><button class="btn" id="btnSubmitPost" onclick="submitPost()" style="flex:1;">ƒêƒÉng b√†i</button></div></div></div>

<div id="authModal" class="modal"><div class="modal-content">
    <h2 class="modal-title" id="authTitle">ƒêƒÉng nh·∫≠p</h2>
    <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="authEmail" placeholder="example@gmail.com"></div>
    <div class="form-group"><label class="form-label">M·∫≠t kh·∫©u</label><input type="password" class="form-input" id="authPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
    <div style="text-align:right; margin-bottom:15px;"><span style="color:var(--text-secondary); font-size:14px; cursor:pointer; text-decoration:underline;" onclick="handleForgotPassword()">Qu√™n m·∫≠t kh·∫©u?</span></div>
    <div id="authMessage" style="color:var(--accent-red); margin-bottom:10px; font-size:14px; display:none;"></div>
    <button class="btn" id="btnAuthAction" onclick="handleAuthAction()">ƒêƒÉng nh·∫≠p</button>
    <div style="text-align:center; margin-top:20px;"><span style="color:var(--text-secondary);" id="authSwitchText">Ch∆∞a c√≥ t√†i kho·∫£n?</span><span style="color:var(--accent-primary); font-weight:bold; cursor:pointer;" onclick="toggleAuthMode()" id="authSwitchBtn">ƒêƒÉng k√Ω ngay</span></div>
    <button class="btn btn-sec" onclick="closeModal('authModal')" style="margin-top:10px;">ƒê√≥ng</button>
</div></div>

<script type="text/javascript">
'use strict';

// 1. CONFIG FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyC4RZXkpXUoogacdxeRSVxcpcH1MouIEuI",
  authDomain: "xingface.firebaseapp.com",
  databaseURL: "https://xingface-default-rtdb.firebaseio.com",
  projectId: "xingface",
  storageBucket: "xingface.firebasestorage.app",
  messagingSenderId: "188925980019",
  appId: "1:188925980019:web:75ea207dae0f5d74fea906",
  measurementId: "G-MJ3QRQV9VW"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

let currentUser = null;
let isLoginMode = true;
// NEW: For 1-on-1 Chat
let currentChatPartnerId = null; 
let currentChatRef = null;

// 2. DATA MANAGEMENT
const DATA_CACHE = { txns: [], passwords: [], posts: [] };
const DB = { 
    get: (key) => DATA_CACHE[key] || [],
    save: (key, data) => db.ref(key).set(data),
    sync: (key, callback) => {
        db.ref(key).on('value', (snapshot) => {
            const val = snapshot.val();
            if (key === 'posts') {
                const arr = val ? Object.values(val) : [];
                DATA_CACHE[key] = arr;
                callback(arr);
            } else {
                const data = val ? (Array.isArray(val) ? val : Object.values(val)) : [];
                DATA_CACHE[key] = data;
                callback(data);
            }
        });
    }
};

// 3. AUTH LOGIC
auth.onAuthStateChanged((user) => {
    currentUser = user;
    updateAuthUI();
    if (user) {
        // L∆∞u user v√†o danh s√°ch chung ƒë·ªÉ m·ªçi ng∆∞·ªùi nh√¨n th·∫•y
        db.ref('users/' + user.uid).set({
            email: user.email,
            status: 'online',
            lastSeen: firebase.database.ServerValue.TIMESTAMP
        });
        // Khi tho√°t th√¨ set offline
        db.ref('users/' + user.uid).onDisconnect().update({ status: 'offline' });
    }
});

function updateAuthUI() {
    const statusText = document.getElementById('authStatusText');
    const emailDisplay = document.getElementById('authEmailDisplay');
    const btnLogin = document.getElementById('btnLoginNav');
    const btnLogout = document.getElementById('btnLogoutNav');
    const myAvatar = document.getElementById('myAvatar');

    if (currentUser) {
        statusText.textContent = "Online";
        statusText.className = "status-badge status-online";
        emailDisplay.textContent = currentUser.email;
        btnLogin.style.display = 'none';
        btnLogout.style.display = 'inline-block';
        if (myAvatar) myAvatar.textContent = currentUser.email.charAt(0).toUpperCase();
    } else {
        statusText.textContent = "Ch∆∞a ƒëƒÉng nh·∫≠p";
        statusText.className = "status-badge status-offline";
        emailDisplay.textContent = "Kh√°ch";
        btnLogin.style.display = 'inline-block';
        btnLogin.textContent = "ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω";
        btnLogout.style.display = 'none';
        if (myAvatar) myAvatar.textContent = "?";
    }
}

function openAuthModal(mode) { isLoginMode = (mode === 'login'); renderAuthModal(); openModal('authModal'); }
function toggleAuthMode() { isLoginMode = !isLoginMode; renderAuthModal(); }
function renderAuthModal() {
    const title = document.getElementById('authTitle'); const btn = document.getElementById('btnAuthAction');
    const switchText = document.getElementById('authSwitchText'); const switchBtn = document.getElementById('authSwitchBtn');
    document.getElementById('authMessage').style.display = 'none';
    if (isLoginMode) { title.textContent = "ƒêƒÉng nh·∫≠p"; btn.textContent = "ƒêƒÉng nh·∫≠p"; switchText.textContent = "Ch∆∞a c√≥ t√†i kho·∫£n? "; switchBtn.textContent = "ƒêƒÉng k√Ω ngay"; }
    else { title.textContent = "ƒêƒÉng k√Ω t√†i kho·∫£n"; btn.textContent = "ƒêƒÉng k√Ω"; switchText.textContent = "ƒê√£ c√≥ t√†i kho·∫£n? "; switchBtn.textContent = "ƒêƒÉng nh·∫≠p"; }
}
async function handleAuthAction() {
    const email = document.getElementById('authEmail').value;
    const pass = document.getElementById('authPass').value;
    const msg = document.getElementById('authMessage');
    if (!email || !pass) { msg.textContent = "Nh·∫≠p ƒë·ªß th√¥ng tin."; msg.style.display = 'block'; return; }
    try {
        if (isLoginMode) {
            await auth.signInWithEmailAndPassword(email, pass);
            closeModal('authModal'); showToast("ƒêƒÉng nh·∫≠p th√†nh c√¥ng!");
        } else {
            await auth.createUserWithEmailAndPassword(email, pass);
            // T·ª± ƒë·ªông ƒëƒÉng nh·∫≠p sau khi ƒëƒÉng k√Ω
            closeModal('authModal'); showToast("ƒêƒÉng k√Ω th√†nh c√¥ng!");
        }
    } catch (error) { msg.textContent = error.message; msg.style.display = 'block'; }
}
function handleLogout() { if(confirm("ƒêƒÉng xu·∫•t?")) { 
    // Set offline tr∆∞·ªõc khi out
    if(currentUser) db.ref('users/' + currentUser.uid).update({ status: 'offline' });
    auth.signOut(); 
}}
async function handleForgotPassword() {
    const email = document.getElementById('authEmail').value;
    if(!email) { alert("Nh·∫≠p Email tr∆∞·ªõc."); return; }
    try { await auth.sendPasswordResetEmail(email); alert("ƒê√£ g·ª≠i email ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u."); } catch(e) { alert("L·ªói: " + e.message); }
}

// 4. POST LOGIC (V·ªöI TIMEOUT FIX)
function renderCommunity(posts) {
    const list = document.getElementById('postsList');
    const sortedPosts = posts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    if (sortedPosts.length === 0) { list.innerHTML = `<div style="text-align:center;padding:30px;color:var(--text-secondary)">Ch∆∞a c√≥ b√†i vi·∫øt n√†o.</div>`; return; }
    list.innerHTML = sortedPosts.map(p => {
        const date = new Date(p.createdAt);
        const timeStr = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        const dateStr = `${date.getDate()}/${date.getMonth()+1}`;
        const shortName = p.authorEmail ? p.authorEmail.split('@')[0] : '·∫®n danh';
        return `<div class="post-card"><div class="post-header"><div class="user-avatar-small" style="background:#555;">${shortName.charAt(0).toUpperCase()}</div><div><div class="post-author-name">${shortName}</div><div class="post-time">${timeStr} ‚Ä¢ ${dateStr}</div></div></div><div class="post-content">${p.content}</div><div class="post-actions"><button class="action-btn">üëç Th√≠ch</button><button class="action-btn">üí¨ B√¨nh lu·∫≠n</button></div></div>`;
    }).join('');
    
    // Check notification for posts
    if(posts.length > 0) {
        const lastPost = posts[0]; // Newest because sorted
        if(currentUser && lastPost.authorId !== currentUser.uid) {
             // Logic th√¥ng b√°o ƒë∆°n gi·∫£n
        }
    }
}
function openCreatePost() {
    if (!currentUser) { alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒëƒÉng b√†i."); openAuthModal('login'); return; }
    document.getElementById('postContent').value = ''; openModal('postModal');
}
function submitPost() {
    const content = document.getElementById('postContent').value.trim();
    if (!content) { alert("N·ªôi dung tr·ªëng!"); return; }
    const btn = document.getElementById('btnSubmitPost');
    const oldText = btn.textContent;
    btn.textContent = "ƒêang ƒëƒÉng..."; btn.disabled = true; btn.style.opacity = "0.7";

    const failsafe = setTimeout(() => {
        btn.textContent = oldText; btn.disabled = false; btn.style.opacity = "1";
        alert("‚ö†Ô∏è QU√Å TH·ªúI GIAN!\nKi·ªÉm tra l·∫°i Rules Firebase ho·∫∑c m·∫°ng.");
    }, 5000);

    db.ref('posts').push({
        content: content, authorEmail: currentUser.email, authorId: currentUser.uid, createdAt: new Date().toISOString()
    }, (error) => {
        clearTimeout(failsafe);
        btn.textContent = oldText; btn.disabled = false; btn.style.opacity = "1";
        if (error) alert("L·ªñI: " + error.message);
        else { closeModal('postModal'); showToast("ƒê√£ ƒëƒÉng!"); }
    });
}

// 5. SCHEDULE & FINANCE & PASSWORDS (GI·ªÆ NGUY√äN)
// (Gi·∫£n l∆∞·ª£c code ph·∫ßn n√†y ƒë·ªÉ t·∫≠p trung v√†o Chat, logic v·∫´n ch·∫°y ng·∫ßm t·ª´ HTML c≈© n·∫øu c·∫ßn)
// Code Schedule, Finance, Password y h·ªát phi√™n b·∫£n tr∆∞·ªõc.
const scheduleData=[{dayName:'Ch·ªß Nh·∫≠t',morning:['','','','',''],afternoon:['','','','','']},{dayName:'Th·ª© Hai',morning:['LS&ƒêL (S·ª≠) ‚Äì Giang','To√°n ‚Äì ƒê. Mai','To√°n ‚Äì ƒê. Mai','Tin ‚Äì √Ånh','KHTN (Sinh) ‚Äì P. Nhung'],afternoon:['C.Ngh·ªá ‚Äì H. V√¢n','LS&ƒêL (ƒê·ªãa) ‚Äì H. Nhung','Ngh·ªá thu·∫≠t (AN) ‚Äì T. Nga','','','']},{dayName:'Th·ª© Ba',morning:['To√°n ‚Äì ƒê. Mai','T.Anh - ƒê.Oanh','GDCD ‚Äì Hu·ªá','KHTN (H√≥a) ‚Äì P. Nhung','KHTN (L√Ω) ‚Äì T. Th√πy'],afternoon:['Ngh·ªá thu·∫≠t (MT) ‚Äì Th√πy','GDTC ‚Äì Tu·∫•n','C.Ngh·ªá ‚Äì H. V√¢n','','','']},{dayName:'Th·ª© T∆∞',morning:['VƒÉn ‚Äì ƒê. Hoa','VƒÉn ‚Äì ƒê. Hoa','LS&ƒêL (S·ª≠) ‚Äì Giang','T.Anh ‚Äì D. Oanh','KHTN (L√Ω) ‚Äì T. Th√πy'],afternoon:['Chi·ªÅu Ngh·ªâ','Chi·ªÅu Ngh·ªâ','Chi·ªÅu Ngh·ªâ','','','']},{dayName:'Th·ª© NƒÉm',morning:['HƒêTN ‚Äì H. Nhung','HƒêTN ‚Äì H. Nhung','HƒêTN ‚Äì H. Nhung','HƒêTN ‚Äì H. Nhung','HƒêTN ‚Äì H. Nhungg',''],afternoon:['Chi·ªÅu Ngh·ªâ','Chi·ªÅu Ngh·ªâ','Chi·ªÅu Ngh·ªâ','','']},{dayName:'Th·ª© S√°u',morning:['GDTC ‚Äì Tu·∫•n','VƒÉn ‚Äì D. Hoa','GDƒêP ‚Äì H. V√¢n','T.Anh ‚Äì D. Oanh','KHTN (H√≥a) ‚Äì P. Nhung'],afternoon:['','','','','']},{dayName:'Th·ª© B·∫£y',morning:['','','','',''],afternoon:['','','','','']}];
let lastRenderedDay=-1;
function updateClockAndSchedule(){const n=new Date();document.getElementById('clock-time').textContent=n.toLocaleTimeString('vi-VN');if(n.getDay()!==lastRenderedDay){renderFullSchedule(n);lastRenderedDay=n.getDay()}}
function renderFullSchedule(n){const d=n.getDay();document.getElementById('clock-date').textContent=n.toLocaleDateString('vi-VN',{weekday:'long',year:'numeric',month:'long',day:'numeric'});const t=scheduleData[d];let h=`<div style="display:flex;justify-content:space-between;align-items:center;"><h3 style="margin-bottom:16px;font-size:20px;font-weight:600;">H√¥m nay</h3><button class="data-btn" id="toggle-tomorrow-btn" onclick="toggleTomorrowSchedule()">Xem ng√†y mai</button></div>`;const o=t.morning.every(s=>!s)&&t.afternoon.every(s=>!s);if(o)h+=`<div class="schedule-item schedule-item-off"><div>ƒê∆∞·ª£c ngh·ªâ</div><span>Ngh·ªâ</span></div>`;else{h+=`<h3 style="font-size:16px;margin:0 0 10px 4px;">S√°ng</h3>`;t.morning.forEach((s,i)=>h+=`<div class="schedule-item ${!s?'schedule-item-off':''}"><div>Ti·∫øt ${i+1}: ${s||'Ngh·ªâ'}</div><span>S√°ng</span></div>`);h+=`<h3 style="font-size:16px;margin:20px 0 10px 4px;">Chi·ªÅu</h3>`;t.afternoon.forEach((s,i)=>h+=`<div class="schedule-item ${!s?'schedule-item-off':''}"><div>Ti·∫øt ${i+6}: ${s||'Ngh·ªâ'}</div><span>Chi·ªÅu</span></div>`)}document.getElementById('today-schedule').innerHTML=h;document.getElementById('future-schedule').innerHTML=`<h3>S·∫Øp t·ªõi</h3>`+[1,2,3,4,5,6].map(k=>{const f=scheduleData[(d+k)%7];const x=f.morning.some(s=>s)||f.afternoon.some(s=>s);return`<div class="schedule-item ${!x?'schedule-item-off':''}"><div>${f.dayName}</div><span>${x?'ƒêi h·ªçc':'Ngh·ªâ'}</span></div>`}).join('')}
function toggleTomorrowSchedule(){const c=document.getElementById('tomorrow-details-container'),b=document.getElementById('toggle-tomorrow-btn');if(c.style.display==='block'){c.style.display='none';b.textContent='Xem ng√†y mai'}else{const t=scheduleData[(new Date().getDay()+1)%7];let h=`<h3>Ng√†y mai (${t.dayName})</h3>`;if(t.morning.every(s=>!s)&&t.afternoon.every(s=>!s))h+=`<div class="schedule-item schedule-item-off"><div>Ngh·ªâ</div><span>Ngh·ªâ</span></div>`;else{h+=`<h4>S√°ng</h4>`;t.morning.forEach((s,i)=>h+=`<div class="schedule-item ${!s?'schedule-item-off':''}"><div>Ti·∫øt ${i+1}: ${s||'Ngh·ªâ'}</div></div>`);h+=`<h4>Chi·ªÅu</h4>`;t.afternoon.forEach((s,i)=>h+=`<div class="schedule-item ${!s?'schedule-item-off':''}"><div>Ti·∫øt ${i+6}: ${s||'Ngh·ªâ'}</div></div>`)}c.innerHTML=h;c.style.display='block';b.textContent='·∫®n chi ti·∫øt'}}
function renderFinance(txns){const n=new Date();const c=txns.filter(t=>new Date(t.date).getMonth()===n.getMonth());let i=0,e=0;c.forEach(t=>t.type==='income'?i+=t.amount:e+=t.amount);const f=v=>new Intl.NumberFormat('vi-VN',{style:'currency',currency:'VND'}).format(v);document.getElementById('bal').textContent=f(i-e);document.getElementById('inc').textContent=f(i);document.getElementById('exp').textContent=f(e);document.getElementById('histList').innerHTML=c.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(t=>`<div class="txn-item"><div><div class="data-title">${t.category}</div><div class="data-subtitle">${t.note||''}</div></div><div class="txn-amount ${t.type==='income'?'green':'red'}">${t.type==='income'?'+':'-'}${new Intl.NumberFormat('vi-VN').format(t.amount)}‚Ç´</div></div>`).join('')}
function openTxn(t){document.getElementById('type').value=t;openModal('txnModal')}
async function saveTxn(){const a=parseFloat(document.getElementById('amt').value);if(!a)return;const t=[...DB.get('txns')];t.push({id:Date.now(),date:new Date().toISOString(),amount:a,category:document.getElementById('cat').value,note:document.getElementById('note').value,type:document.getElementById('type').value});await DB.save('txns',t);closeModal('txnModal')}
function showLastMonthSummary(){const n=new Date();const p=new Date(n.getFullYear(),n.getMonth()-1,1);const e=DB.get('txns').filter(t=>t.type==='expense'&&new Date(t.date).getMonth()===p.getMonth());const s=document.getElementById('summaryContent');if(e.length===0)s.innerHTML='<p style="text-align:center">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>';else{const c={};e.forEach(t=>c[t.category]=(c[t.category]||0)+t.amount);s.innerHTML=Object.entries(c).sort(([,a],[,b])=>b-a).map(([k,v])=>`<div class="txn-item"><div>${k}</div><div class="red">-${new Intl.NumberFormat('vi-VN').format(v)}‚Ç´</div></div>`).join('')}openModal('summaryModal')}
function renderPasswords(a){document.getElementById('passwordsList').innerHTML=a.map(p=>`<div class="data-card"><div class="data-title">${p.service}</div><div class="password-value-container">${p.username}</div><div class="password-value-container">${p.password}</div><button class="data-btn delete" onclick="if(confirm('X√≥a?')) DB.save('passwords',DB.get('passwords').filter(x=>x.id!=${p.id}))">X√≥a</button></div>`).join('')}
function openPasswordModal(){document.getElementById('passwordService').value='';document.getElementById('passwordUsername').value='';document.getElementById('passwordValue').value='';openModal('passwordModal')}
async function savePassword(){const s=document.getElementById('passwordService').value,u=document.getElementById('passwordUsername').value,p=document.getElementById('passwordValue').value;if(!s||!p)return alert("Thi·∫øu th√¥ng tin");const a=[...DB.get('passwords')];a.unshift({id:Date.now(),service:s,username:u,password:p});await DB.save('passwords',a);closeModal('passwordModal')}
function goTo(s,e){document.querySelectorAll('.screen').forEach(x=>x.classList.remove('active'));document.getElementById(s).classList.add('active');document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));e.classList.add('active');const b=document.getElementById('nav-active-bubble');b.style.width=e.offsetWidth+'px';b.style.left=e.offsetLeft+'px'}
function toggleTheme(){const l=document.documentElement.classList.toggle('light-theme');localStorage.setItem('theme',l?'light':'dark')}
function toggleKittyTheme(){const h=document.documentElement;const k=h.classList.contains('kitty-theme');const o=document.getElementById('kitty-transition-overlay');const l=document.getElementById('kitty-logo');o.classList.add('show');setTimeout(()=>{o.style.opacity='1';l.classList.add('show')},10);setTimeout(()=>{if(k){h.classList.remove('kitty-theme');localStorage.setItem('theme','dark')}else{h.classList.add('kitty-theme');localStorage.setItem('theme','kitty')}o.style.opacity='0';setTimeout(()=>{o.classList.remove('show');l.classList.remove('show')},500)},2000)}
function openModal(id){document.getElementById(id).classList.add('show')}
function closeModal(id){document.getElementById(id).classList.remove('show')}
function showToast(m){const t=document.createElement('div');t.className='copy-toast';t.textContent=m;document.body.appendChild(t);setTimeout(()=>t.classList.add('show'),10);setTimeout(()=>{t.classList.remove('show');setTimeout(()=>t.remove(),300)},2000)}
async function resetData(){if(confirm("X√≥a to√†n b·ªô d·ªØ li·ªáu?")){await DB.save('txns',[]);await DB.save('passwords',[]);alert("ƒê√£ x√≥a.")}}


// ============================================
// 6. CHAT 1-ON-1 SYSTEM (NEW)
// ============================================
const chatContainer = document.getElementById('chat-bubble-container');
const userListView = document.getElementById('chat-user-list');
const convoView = document.getElementById('chat-conversation');
const chatTitle = document.getElementById('chatTitleText');
const backBtn = document.getElementById('chatBackBtn');

// Toggle Chat Bubble
function toggleChatBubble() { 
    chatContainer.classList.toggle('hidden'); 
    document.getElementById('notif-badge').classList.remove('active');
    // M·ªü l√™n th√¨ hi·ªán list user ƒë·∫ßu ti√™n
    if(!chatContainer.classList.contains('hidden') && !currentChatPartnerId) {
        loadUserList();
    }
}
function toggleMinimizeChat() { chatContainer.classList.toggle('minimized'); }

// Load danh s√°ch Users
function loadUserList() {
    userListView.style.display = 'block';
    convoView.style.display = 'none';
    backBtn.style.display = 'none';
    chatTitle.textContent = 'Th√†nh vi√™n';
    currentChatPartnerId = null;
    
    // Reset listener c≈©
    if(currentChatRef) { currentChatRef.off(); currentChatRef = null; }

    db.ref('users').once('value', snapshot => {
        const users = [];
        snapshot.forEach(child => {
            const u = child.val();
            u.uid = child.key;
            if(currentUser && u.uid === currentUser.uid) return; // B·ªè qua b·∫£n th√¢n
            users.push(u);
        });

        if(users.length === 0) {
            userListView.innerHTML = '<div style="text-align:center; padding:20px; color:#888;">Ch∆∞a c√≥ th√†nh vi√™n kh√°c online/ƒëƒÉng k√Ω.</div>';
            return;
        }

        userListView.innerHTML = users.map(u => {
            const shortName = u.email.split('@')[0];
            const isOnline = u.status === 'online';
            return `
            <div class="chat-user-item" onclick="openChatWith('${u.uid}', '${shortName}')">
                <div class="chat-user-avatar">
                    ${shortName.charAt(0).toUpperCase()}
                    <div class="chat-user-status-dot ${isOnline?'online':''}"></div>
                </div>
                <div class="chat-user-info">
                    <h4>${shortName}</h4>
                    <p>${isOnline ? 'ƒêang ho·∫°t ƒë·ªông' : 'Offline'}</p>
                </div>
            </div>`;
        }).join('');
    });
}

// M·ªü chat v·ªõi 1 ng∆∞·ªùi
function openChatWith(partnerUid, partnerName) {
    if(!currentUser) { alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ chat."); openAuthModal('login'); return; }
    
    currentChatPartnerId = partnerUid;
    userListView.style.display = 'none';
    convoView.style.display = 'flex';
    backBtn.style.display = 'block';
    chatTitle.textContent = partnerName;
    
    const messagesArea = document.getElementById('chat-messages-area');
    messagesArea.innerHTML = ''; // X√≥a chat c≈©
    
    // T·∫°o Chat ID (Unique ID gi·ªØa 2 ng∆∞·ªùi: lu√¥n l√† uid nh·ªè h∆°n + uid l·ªõn h∆°n)
    const chatId = currentUser.uid < partnerUid ? `${currentUser.uid}_${partnerUid}` : `${partnerUid}_${currentUser.uid}`;
    
    // Listen to messages
    currentChatRef = db.ref('chats/' + chatId);
    currentChatRef.limitToLast(50).on('child_added', snapshot => {
        const msg = snapshot.val();
        appendChatMessage(msg);
    });
}

function backToUserList() {
    loadUserList();
}

function appendChatMessage(msg) {
    const area = document.getElementById('chat-messages-area');
    const isMe = currentUser && msg.senderId === currentUser.uid;
    
    const div = document.createElement('div');
    div.className = `chat-msg ${isMe ? 'me' : 'other'}`;
    div.textContent = msg.text;
    
    area.appendChild(div);
    area.scrollTop = area.scrollHeight;
}

function sendChatMessage() {
    if(!currentUser || !currentChatPartnerId) return;
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if(!text) return;

    const chatId = currentUser.uid < currentChatPartnerId ? `${currentUser.uid}_${currentChatPartnerId}` : `${currentChatPartnerId}_${currentUser.uid}`;
    
    db.ref('chats/' + chatId).push({
        text: text,
        senderId: currentUser.uid,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    });
    
    input.value = '';
}
function handleChatEnter(e) { if(e.key === 'Enter') sendChatMessage(); }

// INIT
document.addEventListener('DOMContentLoaded', () => {
    setInterval(updateClockAndSchedule, 1000); updateClockAndSchedule();
    DB.sync('txns', renderFinance);
    DB.sync('passwords', renderPasswords);
    DB.sync('posts', renderCommunity);

    // Theme logic & Kitty Float (Gi·ªØ nguy√™n)
    if(localStorage.getItem('theme')==='kitty') { document.documentElement.classList.add('kitty-theme'); document.getElementById('kitty-theme-toggle').classList.add('active'); }
    else if(localStorage.getItem('theme')==='light') { document.documentElement.classList.add('light-theme'); }
    const kc = document.getElementById('kitty-float-container');
    for(let i=0;i<15;i++) {
        const k = document.createElement('img'); k.src="https://clipart-library.com/images_k/hello-kitty-transparent-background/hello-kitty-transparent-background-4.png";
        k.className="floating-kitty"; k.style.width=(Math.random()*40+20)+"px"; k.style.top=Math.random()*100+"%"; k.style.animationDuration=(Math.random()*10+8)+"s";
        kc.appendChild(k);
    }
    setTimeout(() => { const a = document.querySelector('.nav-item.active'); if(a) { const b=document.getElementById('nav-active-bubble'); b.style.width=a.offsetWidth+'px'; b.style.left=a.offsetLeft+'px'; } }, 100);
});
</script>
</body>
</html>
