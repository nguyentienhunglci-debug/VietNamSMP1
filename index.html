<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XingChat Final</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* MÀU AUTH (LOTUS STYLE) */
            --primary: #8e2de2; 
            --gradient: linear-gradient(to right, #4a00e0, #8e2de2);
            --bg-light: #ffffff;
            --input-bg: #f2f2f2;
            
            /* MÀU APP (DARK MODE) */
            --app-primary: #0084ff;
            --dark-bg: #0f0f0f;
            --dark-card: #1e1e1e;
            --dark-input: #2a2a2a;
            --text-white: #ffffff;
            --text-gray: #b0b3b8;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; background: white; }

        /* --- 1. CSS CHO PHẦN ĐĂNG NHẬP (SÁNG) --- */
        .auth-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999;
            display: flex; flex-direction: column; padding: 20px;
            transition: transform 0.3s ease-in-out;
            overflow-y: auto;
        }
        .auth-header { margin-top: 10px; margin-bottom: 20px; }
        .back-btn { font-size: 24px; color: #333; cursor: pointer; border: none; background: none; }
        .app-name { font-size: 28px; font-weight: 800; background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .lotus-input {
            width: 100%; padding: 15px 20px; border-radius: 12px; margin-bottom: 15px;
            background: var(--input-bg); border: 1px solid transparent; font-size: 16px; outline: none;
        }
        .lotus-input:focus { background: white; border-color: #8e2de2; }
        .btn-main {
            width: 100%; padding: 15px; border-radius: 30px; background: var(--gradient); color: white;
            font-weight: bold; font-size: 16px; border: none; cursor: pointer; margin-top: 10px;
        }
        .btn-sub {
            width: 100%; padding: 15px; border-radius: 30px; background: #e6e6e6; color: #333;
            font-weight: bold; font-size: 16px; border: none; cursor: pointer; margin-top: 10px;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #8e2de2; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- 2. CSS CHO APP CHÍNH (TỐI) --- */
        #main-app { display: none; background: var(--dark-bg); width: 100%; height: 100vh; color: var(--text-white); padding-bottom: 90px; overflow-y: auto; }
        
        .top-header {
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; background: rgba(15,15,15,0.95); z-index: 100;
            backdrop-filter: blur(10px); border-bottom: 1px solid #333;
        }
        
        .bottom-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; height: 70px;
            background: rgba(30,30,30,0.85); backdrop-filter: blur(20px);
            border-radius: 35px; display: flex; justify-content: space-around; align-items: center;
            z-index: 999; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .nav-item { font-size: 24px; color: #888; cursor: pointer; transition: 0.3s; }
        .nav-item.active { color: var(--app-primary); transform: translateY(-3px); }

        /* Styles cho các Tab */
        .hidden { display: none !important; }
        
        /* Feed */
        .create-post { background: var(--dark-card); padding: 15px; margin: 15px; border-radius: 20px; display:flex; gap:10px; align-items:center; }
        .post-card { background: var(--dark-card); padding: 15px; margin: 0 10px 15px; border-radius: 15px; }
        .user-ava { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; background:#333; }
        
        /* Chat List */
        .search-box { background: var(--dark-input); padding: 12px; border-radius: 15px; display: flex; gap: 10px; align-items: center; margin: 0 15px 15px; }
        .chat-item { display: flex; align-items: center; padding: 12px 15px; gap: 15px; margin: 0 10px; border-radius: 15px; }
        .chat-item:active { background: #333; }
        
        /* Profile */
        .profile-header { background: var(--dark-card); padding: 30px 20px; text-align: center; border-radius: 0 0 30px 30px; margin-bottom: 20px; }
        .big-ava { width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--app-primary); margin-bottom: 10px; }
        .stats-row { display: flex; justify-content: center; gap: 30px; margin-top: 20px; }
        .stat-box { text-align: center; }
        
        /* Chat Window */
        .chat-window { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark-bg); z-index: 5000; display: none; flex-direction: column; }
    </style>
</head>
<body>

<div id="screen-welcome" class="auth-container">
    <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <i class="fas fa-comments" style="font-size:60px; color:#8e2de2; margin-bottom:15px;"></i>
        <div class="app-name">XingChat</div>
        <p style="color:#888;">Kết nối đam mê</p>
    </div>
    <button class="btn-main" onclick="goToStep('login')">Đăng nhập</button>
    <button class="btn-sub" onclick="goToStep('register-email')">Đăng ký</button>
</div>

<div id="screen-login" class="auth-container hidden">
    <div class="auth-header"><button class="back-btn" onclick="goBack('welcome')"><i class="fas fa-chevron-left"></i></button></div>
    <div style="text-align:center; margin-bottom:30px;">
        <div class="app-name" style="font-size:24px;">Đăng nhập</div>
    </div>
    <input type="email" id="login-email" class="lotus-input" placeholder="Email">
    <input type="password" id="login-pass" class="lotus-input" placeholder="Mật khẩu">
    <div style="text-align:right; margin-bottom:20px;"><span onclick="goToStep('forgot')" style="color:#8e2de2; font-weight:bold; cursor:pointer;">Quên mật khẩu?</span></div>
    <div id="login-err" style="color:red; font-size:13px; display:none; margin-bottom:10px;"></div>
    <button class="btn-main" onclick="doLogin()">Đăng nhập</button>
</div>

<div id="screen-forgot" class="auth-container hidden">
    <div class="auth-header"><button class="back-btn" onclick="goBack('login')"><i class="fas fa-chevron-left"></i></button></div>
    <div style="text-align:center; margin-bottom:20px;">
        <div class="app-name" style="font-size:24px;">Khôi phục mật khẩu</div>
    </div>
    <input type="email" id="forgot-email" class="lotus-input" placeholder="Nhập Email">
    <button class="btn-main" onclick="handleForgot()">Gửi liên kết</button>
</div>

<div id="screen-register-email" class="auth-container hidden">
    <div class="auth-header"><button class="back-btn" onclick="goBack('welcome')"><i class="fas fa-chevron-left"></i></button></div>
    <input type="email" id="reg-email" class="lotus-input" placeholder="Email xác thực">
    <button class="btn-sub" onclick="checkRegEmail()">Tiếp tục</button>
</div>

<div id="screen-register-pass" class="auth-container hidden">
    <div class="auth-header"><button class="back-btn" onclick="goBack('register-email')"><i class="fas fa-chevron-left"></i></button></div>
    <input type="password" id="reg-pass" class="lotus-input" placeholder="Tạo mật khẩu (min 6 ký tự)">
    <button class="btn-sub" onclick="checkRegPass()">Tiếp tục</button>
</div>

<div id="screen-register-info" class="auth-container hidden">
    <div class="auth-header"><button class="back-btn" onclick="goBack('register-pass')"><i class="fas fa-chevron-left"></i></button></div>
    <input type="text" id="reg-name" class="lotus-input" placeholder="Tên hiển thị (Vd: Tuấn)">
    <input type="text" id="reg-id" class="lotus-input" placeholder="XingChat ID (Vd: tuan123)" maxlength="20">
    <div id="reg-err" style="color:red; font-size:13px; display:none;"></div>
    <button class="btn-main" onclick="finishReg()">Hoàn tất</button>
</div>

<div id="screen-loading" class="auth-container hidden" style="justify-content:center; align-items:center;">
    <div class="spinner"></div>
    <div style="color:#888;">Đang xử lý...</div>
</div>


<div id="main-app">
    <div class="top-header">
        <div style="font-size:24px; font-weight:bold; color:var(--app-primary);">XingChat</div>
        <i class="fas fa-bell" style="font-size:20px;"></i>
    </div>

    <div id="tab-feed">
        <div class="create-post">
            <img id="my-ava-small" class="user-ava" src="">
            <input id="post-inp" type="text" placeholder="Bạn đang nghĩ gì?" style="flex:1; background:transparent; border:none; color:white; outline:none;">
            <i class="fas fa-paper-plane" style="color:var(--app-primary); cursor:pointer;" onclick="postStatus()"></i>
        </div>
        <div id="feed-list" style="padding-bottom:10px;"></div>
    </div>

    <div id="tab-chat" class="hidden">
        <div class="search-box">
            <i class="fas fa-search" style="color:gray;"></i>
            <input type="text" placeholder="Tìm ID bạn bè..." oninput="searchUser(this.value)" style="background:transparent; border:none; color:white; flex:1; outline:none;">
        </div>
        <div id="search-results" style="padding:0 15px;"></div>
        <div id="chat-list" style="padding-bottom:10px;"></div>
    </div>

    <div id="tab-profile" class="hidden">
        <div class="profile-header">
            <img id="p-ava" class="big-ava" src="">
            <h2 id="p-name" style="margin:0;">Loading...</h2>
            <p id="p-email" style="color:gray; margin:5px 0; font-size:14px;"></p>
            <div class="stats-row">
                <div class="stat-box"><b id="stat-friends" style="font-size:20px;">0</b><br><span style="font-size:12px; color:gray;">Bạn bè</span></div>
                <div class="stat-box"><b id="stat-posts" style="font-size:20px;">0</b><br><span style="font-size:12px; color:gray;">Bài viết</span></div>
            </div>
            <button onclick="logout()" style="margin-top:20px; background:#333; color:var(--text-white); border:none; padding:10px 20px; border-radius:20px; font-weight:bold;">Đăng xuất</button>
        </div>
        <div style="padding:0 15px; font-weight:bold; margin-bottom:10px;">Bài viết của tôi</div>
        <div id="my-posts-list"></div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('feed')"><i class="fas fa-home"></i></div>
        <div class="nav-item" onclick="switchTab('chat')"><i class="fas fa-comment-dots"></i></div>
        <div class="nav-item" onclick="switchTab('profile')"><i class="fas fa-user"></i></div>
    </div>
</div>

<div id="chat-window" class="chat-window">
    <div style="padding:15px; background:rgba(30,30,30,0.95); display:flex; align-items:center; border-bottom:1px solid #333;">
        <i class="fas fa-chevron-left" onclick="closeChat()" style="font-size:24px; padding:10px; cursor:pointer;"></i>
        <b id="cw-name" style="font-size:18px; margin-left:10px;">User</b>
    </div>
    <div id="cw-msgs" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:10px;"></div>
    <div style="padding:10px; background:#1e1e1e; display:flex; align-items:center;">
        <label for="img-up" style="padding:10px;"><i class="fas fa-image" style="font-size:24px; color:var(--app-primary);"></i></label>
        <input type="file" id="img-up" hidden accept="image/*" onchange="sendImage(this)">
        <input id="cw-inp" type="text" placeholder="Nhắn tin..." style="flex:1; background:#333; border:none; padding:12px 15px; border-radius:20px; color:white; outline:none; margin:0 5px;">
        <button onclick="sendMsg()" style="background:none; border:none; color:var(--app-primary); font-size:22px; padding:10px;"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, serverTimestamp, collection, query, orderBy, onSnapshot, where, updateDoc, arrayUnion, addDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";

    // CONFIG CỦA BẠN (13d44)
    const firebaseConfig = {
      apiKey: "AIzaSyAICFb4QrXY2pDzyuf9u-YF9kX5xlaBss0",
      authDomain: "xingchat-13d44.firebaseapp.com",
      projectId: "xingchat-13d44",
      storageBucket: "xingchat-13d44.firebasestorage.app",
      messagingSenderId: "802782197419",
      appId: "1:802782197419:web:91b50dc75ee978fd0aa9ee"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    
    let me = null; // User data
    let activeChatID = null;
    let tEmail="", tPass="";

    // --- 1. AUTH LOGIC ---
    window.goToStep = (id) => {
        document.querySelectorAll('.auth-container').forEach(e=>e.classList.add('hidden'));
        document.getElementById('screen-'+id).classList.remove('hidden');
    }
    window.goBack = (id) => window.goToStep(id);

    window.doLogin = async () => {
        const e = document.getElementById('login-email').value;
        const p = document.getElementById('login-pass').value;
        if(!e||!p) return alert("Nhập thiếu thông tin");
        
        document.getElementById('screen-login').classList.add('hidden');
        document.getElementById('screen-loading').classList.remove('hidden');
        try { await signInWithEmailAndPassword(auth,e,p); }
        catch(err) {
            document.getElementById('screen-loading').classList.add('hidden');
            document.getElementById('screen-login').classList.remove('hidden');
            alert("Sai thông tin đăng nhập");
        }
    }

    window.handleForgot = async () => {
        const e = document.getElementById('forgot-email').value;
        if(!e.includes('@')) return alert("Email sai");
        try { await sendPasswordResetEmail(auth,e); alert("Đã gửi link vào mail!"); window.goToStep('login'); }
        catch(err) { alert(err.message); }
    }

    window.checkRegEmail = () => { tEmail=document.getElementById('reg-email').value; if(tEmail.includes('@')) window.goToStep('register-pass'); else alert("Email sai"); }
    window.checkRegPass = () => { tPass=document.getElementById('reg-pass').value; if(tPass.length>=6) window.goToStep('register-info'); else alert("Mật khẩu ngắn"); }
    window.finishReg = async () => {
        const name = document.getElementById('reg-name').value;
        const id = document.getElementById('reg-id').value.toLowerCase();
        if(!name||!id) return alert("Điền đủ thông tin");
        
        document.getElementById('screen-register-info').classList.add('hidden');
        document.getElementById('screen-loading').classList.remove('hidden');
        try {
            if((await getDoc(doc(db,"ids",id))).exists()) throw new Error("ID đã tồn tại");
            const res = await createUserWithEmailAndPassword(auth,tEmail,tPass);
            await setDoc(doc(db,"users",res.user.uid), { email:tEmail, id:id, displayName:name, friends:[], createdAt:serverTimestamp() });
            await setDoc(doc(db,"ids",id), { uid:res.user.uid });
        } catch(e) {
            document.getElementById('screen-loading').classList.add('hidden');
            document.getElementById('screen-register-info').classList.remove('hidden');
            alert(e.message);
        }
    }
    window.logout = () => signOut(auth);

    onAuthStateChanged(auth, async (user) => {
        if(user) {
            document.querySelectorAll('.auth-container').forEach(e=>e.classList.add('hidden'));
            const snap = await getDoc(doc(db,"users",user.uid));
            if(snap.exists()) {
                me = { uid:user.uid, ...snap.data() };
                document.getElementById('main-app').style.display='block';
                loadMainApp();
            }
        } else {
            document.getElementById('main-app').style.display='none';
            document.getElementById('screen-welcome').classList.remove('hidden');
        }
    });

    // --- 2. APP LOGIC (ĐƯỢC KHÔI PHỤC) ---
    function loadMainApp() {
        const ava = `https://ui-avatars.com/api/?name=${me.displayName}&background=0084ff&color=fff&size=200`;
        document.getElementById('my-ava-small').src = ava;
        document.getElementById('p-ava').src = ava;
        document.getElementById('p-name').innerText = me.displayName + " (@"+me.id+")";
        document.getElementById('p-email').innerText = me.email;
        document.getElementById('stat-friends').innerText = me.friends ? me.friends.length : 0;
        
        loadFeed(); loadChatList();
        // Load bài viết cá nhân
        onSnapshot(query(collection(db,"posts"),where("uid","==",me.uid)), s => document.getElementById('stat-posts').innerText=s.size);
        loadMyPosts();
    }

    window.switchTab = (tab) => {
        document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
        ['tab-feed','tab-chat','tab-profile'].forEach(id=>document.getElementById(id).classList.add('hidden'));
        if(tab==='feed'){ document.querySelectorAll('.nav-item')[0].classList.add('active'); document.getElementById('tab-feed').classList.remove('hidden'); }
        else if(tab==='chat'){ document.querySelectorAll('.nav-item')[1].classList.add('active'); document.getElementById('tab-chat').classList.remove('hidden'); }
        else { document.querySelectorAll('.nav-item')[2].classList.add('active'); document.getElementById('tab-profile').classList.remove('hidden'); }
    }

    // FEED
    window.postStatus = async () => {
        const c = document.getElementById('post-inp').value; if(!c.trim()) return;
        await addDoc(collection(db,"posts"), { uid:me.uid, author:me.displayName, content:c, createdAt:serverTimestamp() });
        document.getElementById('post-inp').value="";
    }
    function loadFeed() {
        onSnapshot(query(collection(db,"posts"), orderBy("createdAt","desc")), snap => {
            const list = document.getElementById('feed-list'); list.innerHTML="";
            snap.forEach(d => {
                const p = d.data();
                list.innerHTML += `<div class="post-card"><b style="color:#0084ff">${p.author}</b>: ${p.content}</div>`;
            });
        });
    }

    // PROFILE POSTS
    function loadMyPosts() {
        onSnapshot(query(collection(db,"posts"), where("uid","==",me.uid), orderBy("createdAt","desc")), snap => {
            const list = document.getElementById('my-posts-list'); list.innerHTML="";
            snap.forEach(d => {
                const p = d.data();
                list.innerHTML += `<div class="post-card" style="font-size:14px;">${p.content}</div>`;
            });
        });
    }

    // CHAT
    window.searchUser = async (val) => {
        const box = document.getElementById('search-results'); box.innerHTML=""; if(!val) return;
        const d = await getDoc(doc(db,"ids",val.toLowerCase()));
        if(d.exists() && d.data().uid !== me.uid) {
            box.innerHTML = `<div class="chat-item" style="background:#333;"><b>@${val}</b> <button onclick="addFriend('${d.data().uid}')" style="margin-left:auto;">Kết bạn</button></div>`;
        }
    }
    window.addFriend = async (uid) => {
        await updateDoc(doc(db,"users",me.uid),{friends:arrayUnion(uid)});
        await updateDoc(doc(db,"users",uid),{friends:arrayUnion(me.uid)});
        alert("Đã kết bạn!");
    }
    function loadChatList() {
        onSnapshot(doc(db,"users",me.uid), async(s) => {
            const f = s.data().friends||[]; const l = document.getElementById('chat-list'); l.innerHTML="";
            for(const fid of f) {
                const u = await getDoc(doc(db,"users",fid));
                if(u.exists()) {
                    const el = document.createElement('div'); el.className="chat-item";
                    el.innerHTML=`<img src="https://ui-avatars.com/api/?name=${u.data().displayName}" class="user-ava"><div><b>${u.data().displayName}</b></div>`;
                    el.onclick=()=>openChat(fid, u.data().displayName); l.appendChild(el);
                }
            }
        });
    }
    window.openChat = (fid,name) => {
        activeChatID=fid; document.getElementById('chat-window').style.display='flex';
        document.getElementById('cw-name').innerText=name;
        onSnapshot(query(collection(db,"chats",[me.uid,fid].sort().join("_"),"msgs"), orderBy("t","asc")), s=>{
            const b=document.getElementById('cw-msgs'); b.innerHTML="";
            s.forEach(d=>{
                const m=d.data(); const isMe=m.by===me.uid;
                const div=document.createElement('div');
                div.style=`max-width:70%; padding:10px; border-radius:15px; margin-bottom:5px; align-self:${isMe?'flex-end':'flex-start'}; background:${isMe?'#0084ff':'#333'}`;
                if(m.type==='img') div.innerHTML=`<img src="${m.txt}" style="max-width:100%; border-radius:10px;">`; else div.innerText=m.txt;
                b.appendChild(div);
            });
            b.scrollTop=b.scrollHeight;
        });
    }
    window.closeChat = () => { document.getElementById('chat-window').style.display='none'; activeChatID=null; }
    window.sendMsg = async () => {
        const t=document.getElementById('cw-inp').value; if(!t||!activeChatID) return;
        await addDoc(collection(db,"chats",[me.uid,activeChatID].sort().join("_"),"msgs"),{by:me.uid,txt:t,type:'text',t:Date.now()});
        document.getElementById('cw-inp').value="";
    }
    window.sendImage = async (inp) => {
        const f=inp.files[0]; if(!f||!activeChatID) return;
        const r=ref(storage,`c/${Date.now()}_${f.name}`); await uploadBytes(r,f);
        await addDoc(collection(db,"chats",[me.uid,activeChatID].sort().join("_"),"msgs"),{by:me.uid,txt:await getDownloadURL(r),type:'img',t:Date.now()});
    }
</script>
</body>
</html>
