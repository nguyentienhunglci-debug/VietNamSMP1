<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocialChat - Kết nối đam mê</title>
    <style>
        /* --- CSS GIAO DIỆN CHUNG --- */
        body {
            font-family: 'Segoe UI', Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0; padding: 0;
            color: #1c1e21;
        }

        /* --- CSS CHO PHẦN ĐĂNG NHẬP / ĐĂNG KÝ (LÀM ĐẸP) --- */
        #auth-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #f0f2f5 0%, #e1e5ea 100%);
        }

        .auth-card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .auth-card h1 { color: #1877f2; margin-bottom: 10px; font-size: 32px; }
        .auth-card h3 { color: #606770; margin-bottom: 20px; font-weight: normal; }

        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #dddfe2;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
            outline: none;
            transition: border-color 0.2s;
        }
        .form-group input:focus { border-color: #1877f2; box-shadow: 0 0 0 2px #e7f3ff; }

        .btn-primary {
            background-color: #1877f2;
            color: white;
            font-size: 18px;
            font-weight: bold;
            padding: 12px;
            border: none;
            border-radius: 6px;
            width: 100%;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-primary:hover { background-color: #166fe5; }

        .btn-success {
            background-color: #42b72a;
            color: white;
            font-size: 16px;
            font-weight: bold;
            padding: 12px;
            border: none;
            border-radius: 6px;
            width: auto;
            min-width: 60%;
            margin-top: 15px;
            cursor: pointer;
        }
        .btn-success:hover { background-color: #36a420; }

        .divider { border-bottom: 1px solid #dadde1; margin: 20px 0; }
        .link-text { color: #1877f2; cursor: pointer; font-size: 14px; text-decoration: none; }
        .link-text:hover { text-decoration: underline; }

        /* --- CSS APP CHÍNH (GIỮ NGUYÊN HOẶC CHỈNH NHẸ) --- */
        #main-app { display: none; padding-bottom: 60px; max-width: 600px; margin: 0 auto; background: white; min-height: 100vh; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        
        .header { background: #fff; padding: 10px 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .tabs { display: flex; justify-content: space-around; border-bottom: 1px solid #ddd; margin-top: 10px; }
        .tab { padding: 12px; cursor: pointer; color: #65676b; font-weight: 600; width: 50%; text-align: center; position: relative; }
        .tab.active { color: #1877f2; }
        .tab.active::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: #1877f2; }
        
        /* Post Styles */
        .post-input { padding: 15px; border-bottom: 8px solid #f0f2f5; }
        .post { padding: 15px; border-bottom: 8px solid #f0f2f5; }
        .post-header { font-weight: bold; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .post-content { font-size: 15px; margin-bottom: 12px; line-height: 1.4; }
        
        /* Chat Styles */
        .chat-window { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: white; z-index: 200; flex-direction: column; }
        .messages-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; background-color: #fff; }
        .msg { padding: 8px 12px; border-radius: 18px; max-width: 75%; word-wrap: break-word; font-size: 15px; }
        .msg.me { background: #0084ff; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .msg.them { background: #e4e6eb; color: black; align-self: flex-start; border-bottom-left-radius: 4px; }

        /* Helpers */
        .hidden { display: none !important; }
        .error-msg { color: red; font-size: 13px; margin-top: 5px; text-align: left; display: none; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="auth-card">
        <h1>SocialChat</h1>
        
        <div id="login-form">
            <h3>Đăng nhập vào tài khoản</h3>
            <div class="form-group">
                <input type="email" id="login-email" placeholder="Email hoặc số điện thoại">
            </div>
            <div class="form-group">
                <input type="password" id="login-pass" placeholder="Mật khẩu">
            </div>
            <div id="login-error" class="error-msg"></div>
            
            <button class="btn-primary" onclick="handleLogin()">Đăng nhập</button>
            <div class="divider"></div>
            <button class="btn-success" onclick="toggleAuth('register')">Tạo tài khoản mới</button>
        </div>

        <div id="register-form" class="hidden">
            <h3>Đăng ký nhanh chóng</h3>
            <div class="form-group">
                <input type="email" id="reg-email" placeholder="Email (dùng để xác thực)">
            </div>
            <div class="form-group">
                <input type="password" id="reg-pass" placeholder="Mật khẩu mới">
            </div>
            <div class="form-group">
                <input type="text" id="reg-id" placeholder="Tạo ID (ví dụ: hung123)" maxlength="20">
                <p style="font-size: 12px; color: #606770; margin: 5px 0 0 0;">* ID gồm chữ thường và số, không dấu, max 20 kí tự.</p>
            </div>
            <div id="reg-error" class="error-msg"></div>

            <button class="btn-success" onclick="handleRegister()" style="width: 100%;">Đăng ký</button>
            <div style="margin-top: 15px;">
                <span class="link-text" onclick="toggleAuth('login')">Bạn đã có tài khoản?</span>
            </div>
        </div>
    </div>
</div>

<div id="main-app">
    <div class="header">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <b id="current-user-id" style="font-size: 18px; color: #1877f2;">Loading...</b>
            <button onclick="logout()" style="border:none; background:#e4e6eb; padding:6px 12px; border-radius:6px; cursor:pointer; font-weight:bold;">Đăng xuất</button>
        </div>
        <div class="tabs">
            <div class="tab active" onclick="switchTab('feed')">Bảng tin</div>
            <div class="tab" onclick="switchTab('chat')">Nhắn tin</div>
        </div>
    </div>

    <div id="tab-feed">
        <div class="post-input">
            <div style="display:flex; gap: 10px;">
                <textarea id="post-content" rows="2" style="width:100%; border:none; resize:none; outline:none; font-family:inherit; font-size: 16px;" placeholder="Bạn đang nghĩ gì thế?"></textarea>
            </div>
            <div style="text-align: right; margin-top: 5px;">
                <button onclick="createPost()" style="background:#1877f2; color:white; border:none; padding: 6px 20px; border-radius: 6px; font-weight:bold; cursor:pointer;">Đăng</button>
            </div>
        </div>
        <div id="feed-list">
            </div>
    </div>

    <div id="tab-chat" class="hidden">
        <div style="padding: 15px; background: #fff; border-bottom: 1px solid #ddd;">
            <div style="display: flex; gap: 5px;">
                <input type="text" id="friend-id-input" placeholder="Nhập ID bạn bè..." style="flex:1; padding: 8px; border:1px solid #ddd; border-radius: 6px;">
                <button onclick="sendFriendRequest()" style="background:#1877f2; color:white; border:none; padding:0 15px; border-radius:6px; cursor:pointer;">Thêm bạn</button>
            </div>
        </div>
        <div id="friend-requests-area"></div>
        
        <h4 style="padding: 15px 15px 5px 15px; margin:0; color: #65676b;">Danh sách trò chuyện</h4>
        <div id="friend-list"></div>
    </div>
</div>

<div id="chat-window" class="chat-window">
    <div class="header" style="background: white; border-bottom: 1px solid #ddd; display:flex; align-items:center;">
        <button onclick="closeChat()" style="background:transparent; border:none; font-size:20px; padding:0 10px; cursor:pointer; color:#1877f2;">&#10094;</button>
        <div style="display:flex; flex-direction:column; margin-left: 5px;">
            <span id="chat-with-name" style="font-weight:bold; font-size:16px;">User</span>
            <span style="font-size:11px; color:green;">Đang hoạt động</span>
        </div>
    </div>
    <div id="messages-box" class="messages-box"></div>
    <div style="padding:10px; background:white; border-top:1px solid #ddd; display:flex; align-items:center;">
        <input type="text" id="msg-input" placeholder="Nhập tin nhắn..." style="flex:1; padding:10px; border-radius:20px; border:1px solid #ddd; outline:none; background:#f0f2f5; margin-right:8px;">
        <button onclick="sendMessage()" style="background:transparent; color:#1877f2; border:none; font-weight:bold; font-size:16px; cursor:pointer;">Gửi</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { 
        getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendEmailVerification 
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { 
        getFirestore, collection, addDoc, query, where, onSnapshot, orderBy, serverTimestamp, setDoc, doc, getDoc, updateDoc, arrayUnion 
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // CẤU HÌNH FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyDINi8lDjGXvvN4_nB9hNRcoMVBQowp0xk",
      authDomain: "web-chatonline.firebaseapp.com",
      projectId: "web-chatonline",
      storageBucket: "web-chatonline.firebasestorage.app",
      messagingSenderId: "579594121865",
      appId: "1:579594121865:web:3167668be5a42bb4a2cc58",
      measurementId: "G-RJC8W88TGT"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    let currentUser = null;
    let currentCustomId = "";
    let activeChatFriendId = null;

    // --- UI HELPERS ---
    window.toggleAuth = (mode) => {
        document.getElementById('login-error').style.display = 'none';
        document.getElementById('reg-error').style.display = 'none';
        if(mode === 'register') {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
        } else {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('register-form').classList.add('hidden');
        }
    };

    function showError(elementId, msg) {
        const el = document.getElementById(elementId);
        el.innerText = msg;
        el.style.display = 'block';
    }

    // --- LOGIC AUTHENTICATION (CÓ XÁC THỰC EMAIL) ---

    window.handleRegister = async () => {
        const email = document.getElementById('reg-email').value;
        const pass = document.getElementById('reg-pass').value;
        const customId = document.getElementById('reg-id').value.toLowerCase().trim();

        if(!email || !pass || !customId) return showError('reg-error', "Vui lòng điền đầy đủ thông tin.");
        
        const idRegex = /^[a-z0-9]{1,20}$/;
        if (!idRegex.test(customId)) return showError('reg-error', "ID chỉ gồm chữ thường, số, max 20 kí tự.");

        try {
            // Check ID
            const idRef = doc(db, "usernames", customId);
            const idSnap = await getDoc(idRef);
            if (idSnap.exists()) return showError('reg-error', "ID này đã có người dùng.");

            // Create User
            const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
            const user = userCredential.user;

            // Save Data
            await setDoc(doc(db, "users", user.uid), {
                email: email, customId: customId, friends: [], createdAt: serverTimestamp()
            });
            await setDoc(doc(db, "usernames", customId), { uid: user.uid });

            // SEND VERIFICATION EMAIL
            await sendEmailVerification(user);
            
            // Sign out immediately to force login after verify
            await signOut(auth);

            alert("ĐĂNG KÝ THÀNH CÔNG!\nChúng tôi đã gửi link xác nhận vào email: " + email + "\nVui lòng mở email và bấm vào link để kích hoạt tài khoản trước khi đăng nhập.");
            
            window.toggleAuth('login');
        } catch (error) {
            showError('reg-error', error.message);
        }
    };

    window.handleLogin = async () => {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-pass').value;
        
        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, pass);
            const user = userCredential.user;

            if (!user.emailVerified) {
                // Nếu chưa xác thực email -> Logout ngay và báo lỗi
                await signOut(auth);
                showError('login-error', "Email chưa được xác thực! Vui lòng kiểm tra hộp thư đến (hoặc spam) để kích hoạt tài khoản.");
                return;
            }
            // Nếu đã verified -> onAuthStateChanged sẽ xử lý việc chuyển màn hình
        } catch (error) {
            showError('login-error', "Sai email hoặc mật khẩu.");
        }
    };

    window.logout = () => signOut(auth);

    onAuthStateChanged(auth, async (user) => {
        if (user && user.emailVerified) {
            // Chỉ cho vào khi có user VÀ email đã verified
            currentUser = user;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists()) {
                currentCustomId = userDoc.data().customId;
                document.getElementById('current-user-id').innerText = "@" + currentCustomId;
                loadNewsFeed();
                loadFriendsList();
                listenFriendRequests();
            }
        } else {
            currentUser = null;
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('main-app').style.display = 'none';
        }
    });

    // --- CÁC HÀM XỬ LÝ APP (NHƯ CŨ) ---
    
    window.switchTab = (tabName) => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        if (tabName === 'feed') {
            document.querySelectorAll('.tab')[0].classList.add('active');
            document.getElementById('tab-feed').classList.remove('hidden');
            document.getElementById('tab-chat').classList.add('hidden');
        } else {
            document.querySelectorAll('.tab')[1].classList.add('active');
            document.getElementById('tab-feed').classList.add('hidden');
            document.getElementById('tab-chat').classList.remove('hidden');
        }
    };

    window.createPost = async () => {
        const content = document.getElementById('post-content').value;
        if (!content.trim()) return;
        await addDoc(collection(db, "posts"), {
            uid: currentUser.uid, authorId: currentCustomId, content: content, createdAt: serverTimestamp(), comments: []
        });
        document.getElementById('post-content').value = "";
    };

    function loadNewsFeed() {
        const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            const feedDiv = document.getElementById('feed-list');
            feedDiv.innerHTML = "";
            snapshot.forEach((docSnap) => {
                const post = docSnap.data();
                const postId = docSnap.id;
                const postEl = document.createElement('div');
                postEl.className = 'post';
                postEl.innerHTML = `
                    <div class="post-header">
                        <span style="color:#1c1e21; font-weight:bold;">@${post.authorId}</span>
                        <small style="color:#65676b; font-weight:normal;">${post.createdAt ? new Date(post.createdAt.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : ''}</small>
                    </div>
                    <div class="post-content">${post.content}</div>
                    <div style="background:#f0f2f5; padding:8px; border-radius:8px; margin-top:10px;">
                        <div id="comments-${postId}" style="margin-bottom:8px; font-size:13px;">
                             ${post.comments ? post.comments.map(c => `<div><b>@${c.author}:</b> ${c.text}</div>`).join('') : ''}
                        </div>
                        <div style="display:flex;">
                            <input type="text" placeholder="Viết bình luận..." id="cmt-input-${postId}" style="flex:1; border:none; background:white; padding:5px 10px; border-radius:15px; outline:none;">
                            <button onclick="addComment('${postId}')" style="margin-left:5px; border:none; background:transparent; color:#1877f2; font-weight:bold; cursor:pointer;">Gửi</button>
                        </div>
                    </div>
                `;
                feedDiv.appendChild(postEl);
            });
        });
    }

    window.addComment = async (postId) => {
        const input = document.getElementById(`cmt-input-${postId}`);
        if (!input.value) return;
        await updateDoc(doc(db, "posts", postId), {
            comments: arrayUnion({ author: currentCustomId, text: input.value })
        });
    };

    window.sendFriendRequest = async () => {
        const targetId = document.getElementById('friend-id-input').value.toLowerCase().trim();
        if (targetId === currentCustomId) return alert("Không thể kết bạn với chính mình!");
        const targetDoc = await getDoc(doc(db, "usernames", targetId));
        if (!targetDoc.exists()) return alert("ID không tồn tại!");
        
        await addDoc(collection(db, "friend_requests"), {
            fromUid: currentUser.uid, fromId: currentCustomId, toUid: targetDoc.data().uid, status: 'pending'
        });
        alert("Đã gửi lời mời!");
        document.getElementById('friend-id-input').value = "";
    };

    function listenFriendRequests() {
        const q = query(collection(db, "friend_requests"), where("toUid", "==", currentUser.uid), where("status", "==", "pending"));
        onSnapshot(q, (snap) => {
            const area = document.getElementById('friend-requests-area');
            area.innerHTML = "";
            snap.forEach(req => {
                const data = req.data();
                const div = document.createElement('div');
                div.style.padding = "10px"; div.style.background = "#e7f3ff"; div.style.margin = "10px 15px"; div.style.borderRadius = "8px";
                div.innerHTML = `
                    <span><b>@${data.fromId}</b> muốn kết bạn</span>
                    <button onclick="acceptFriend('${req.id}', '${data.fromUid}')" style="float:right; background:#42b72a; color:white; border:none; padding:4px 10px; border-radius:4px; cursor:pointer;">Đồng ý</button>
                `;
                area.appendChild(div);
            });
        });
    }

    window.acceptFriend = async (reqId, newFriendUid) => {
        await updateDoc(doc(db, "friend_requests", reqId), { status: 'accepted' });
        await updateDoc(doc(db, "users", currentUser.uid), { friends: arrayUnion(newFriendUid) });
        await updateDoc(doc(db, "users", newFriendUid), { friends: arrayUnion(currentUser.uid) });
    };

    function loadFriendsList() {
        onSnapshot(doc(db, "users", currentUser.uid), async (docSnap) => {
            const data = docSnap.data();
            const friendListDiv = document.getElementById('friend-list');
            friendListDiv.innerHTML = "";
            if (data.friends && data.friends.length > 0) {
                for (const friendUid of data.friends) {
                    const friendUserSnap = await getDoc(doc(db, "users", friendUid));
                    if (friendUserSnap.exists()) {
                        const friendData = friendUserSnap.data();
                        const item = document.createElement('div');
                        item.style.padding = "15px"; item.style.borderBottom = "1px solid #f0f2f5"; item.style.cursor = "pointer";
                        item.innerHTML = `<div style="display:flex; align-items:center;"><div style="width:40px; height:40px; background:#ddd; border-radius:50%; display:flex; justify-content:center; align-items:center; font-weight:bold; color:#555; margin-right:10px;">${friendData.customId[0].toUpperCase()}</div><b>@${friendData.customId}</b></div>`;
                        item.onclick = () => openChat(friendUid, friendData.customId);
                        friendListDiv.appendChild(item);
                    }
                }
            } else {
                friendListDiv.innerHTML = '<p style="text-align:center; color:gray; padding:20px;">Chưa có bạn bè.</p>';
            }
        });
    }

    window.openChat = (friendUid, friendName) => {
        activeChatFriendId = friendUid;
        document.getElementById('chat-window').style.display = 'flex';
        document.getElementById('chat-with-name').innerText = "@" + friendName;
        const chatId = [currentUser.uid, friendUid].sort().join("_");
        const q = query(collection(db, "chats", chatId, "messages"), orderBy("createdAt", "asc"));
        onSnapshot(q, (snap) => {
            const box = document.getElementById('messages-box');
            box.innerHTML = "";
            snap.forEach(d => {
                const msg = d.data();
                const div = document.createElement('div');
                div.className = `msg ${msg.senderId === currentUser.uid ? 'me' : 'them'}`;
                div.innerText = msg.text;
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        });
    };

    window.closeChat = () => { document.getElementById('chat-window').style.display = 'none'; activeChatFriendId = null; };

    window.sendMessage = async () => {
        const text = document.getElementById('msg-input').value.trim();
        if (!text || !activeChatFriendId) return;
        
        // Check friend status
        const myData = (await getDoc(doc(db, "users", currentUser.uid))).data();
        if (!myData.friends.includes(activeChatFriendId)) return alert("Chờ đối phương đồng ý kết bạn!");

        const chatId = [currentUser.uid, activeChatFriendId].sort().join("_");
        await addDoc(collection(db, "chats", chatId, "messages"), {
            text: text, senderId: currentUser.uid, createdAt: serverTimestamp()
        });
        document.getElementById('msg-input').value = "";
    };
</script>
</body>
</html>
