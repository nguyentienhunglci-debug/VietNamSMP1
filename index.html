<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XingChat - Lotus Style</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #8e2de2; 
            --gradient: linear-gradient(to right, #4a00e0, #8e2de2);
            --bg-light: #ffffff;
            --input-bg: #f2f2f2;
            --btn-radius: 30px;
            --dark-bg: #0f0f0f;
            --dark-card: #1e1e1e;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; background: white; }

        /* --- AUTH CSS --- */
        .auth-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999;
            display: flex; flex-direction: column; padding: 20px;
            transition: transform 0.3s ease-in-out;
            overflow-y: auto;
        }

        .auth-header { margin-top: 10px; margin-bottom: 20px; }
        .back-btn { font-size: 24px; color: #333; cursor: pointer; border: none; background: none; padding: 10px 0; }
        
        .logo-area { text-align: center; margin-bottom: 30px; }
        .app-name { font-size: 28px; font-weight: 800; background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .input-group { margin-bottom: 15px; width: 100%; }
        .lotus-input {
            width: 100%; padding: 15px 20px; border-radius: 12px;
            background: var(--input-bg); border: 1px solid transparent;
            font-size: 16px; outline: none; transition: 0.3s;
        }
        .lotus-input:focus { background: white; border-color: #8e2de2; }

        .btn-main {
            width: 100%; padding: 15px; border-radius: var(--btn-radius);
            background: var(--gradient); color: white; font-weight: bold; font-size: 16px;
            border: none; cursor: pointer; margin-top: 10px;
            box-shadow: 0 4px 15px rgba(138, 43, 226, 0.3);
        }
        .btn-sub {
            width: 100%; padding: 15px; border-radius: var(--btn-radius);
            background: #e6e6e6; color: #333; font-weight: bold; font-size: 16px;
            border: none; cursor: pointer; margin-top: 10px;
        }

        .forgot-link {
            text-align: right; margin-bottom: 20px;
        }
        .forgot-link span {
            color: #8e2de2; font-weight: 600; font-size: 14px; cursor: pointer;
        }

        /* --- LOADING & UTILS --- */
        #screen-loading { background: white; align-items: center; justify-content: center; text-align: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #8e2de2; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .hidden { display: none !important; }
        .error-txt { color: red; font-size: 13px; margin-top: 5px; margin-left: 5px; display: none; }

        /* --- MAIN APP (DARK MODE) --- */
        #main-app { display: none; background: var(--dark-bg); min-height: 100vh; color: white; padding-bottom: 80px; }
        .top-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; background: rgba(30,30,30,0.9); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100; }
        .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; height: 70px; background: rgba(40,40,40,0.8); backdrop-filter: blur(20px); border-radius: 35px; display: flex; justify-content: space-around; align-items: center; z-index: 999; border: 1px solid rgba(255,255,255,0.1); }
        .nav-item { font-size: 24px; color: #888; cursor: pointer; } .nav-item.active { color: #0084ff; }
        .post-card { background: #1e1e1e; padding: 15px; margin: 10px; border-radius: 15px; }
    </style>
</head>
<body>

<div id="screen-welcome" class="auth-container">
    <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <i class="fas fa-comments" style="font-size:60px; color:#8e2de2; margin-bottom:15px;"></i>
        <div class="app-name">XingChat</div>
        <p style="color:#888; margin-top:10px;">Kết nối đam mê</p>
    </div>
    <button class="btn-main" onclick="goToStep('login')">Đăng nhập</button>
    <button class="btn-sub" onclick="goToStep('register-email')">Đăng ký</button>
</div>

<div id="screen-login" class="auth-container hidden">
    <div class="auth-header"><button class="back-btn" onclick="goBack('welcome')"><i class="fas fa-chevron-left"></i></button></div>
    <div class="logo-area">
        <div class="app-name" style="font-size:24px;">Đăng nhập</div>
        <p style="color:#666; font-size:14px;">Chào mừng bạn quay trở lại</p>
    </div>

    <div class="input-group">
        <input type="email" id="login-email" class="lotus-input" placeholder="Email">
    </div>
    <div class="input-group">
        <input type="password" id="login-pass" class="lotus-input" placeholder="Mật khẩu">
    </div>

    <div class="forgot-link">
        <span onclick="goToStep('forgot')">Quên mật khẩu?</span>
    </div>
    <div id="login-error" class="error-txt" style="text-align:center; margin-bottom:10px;"></div>

    <button class="btn-main" onclick="doLoginCombined()">Đăng nhập</button>
</div>

<div id="screen-forgot" class="auth-container hidden">
    <div class="auth-header"><button class="back-btn" onclick="goBack('login')"><i class="fas fa-chevron-left"></i></button></div>
    <div class="logo-area">
        <div class="app-name" style="font-size:24px;">Khôi phục mật khẩu</div>
        <p style="color:#666; font-size:14px; padding:0 20px;">Nhập email của bạn, chúng tôi sẽ gửi liên kết đặt lại mật khẩu.</p>
    </div>

    <div class="input-group">
        <input type="email" id="forgot-email" class="lotus-input" placeholder="Nhập Email của bạn">
    </div>
    
    <button class="btn-main" onclick="handleForgotPassword()">Gửi liên kết</button>
</div>

<div id="screen-register-email" class="auth-container hidden">
    <div class="auth-header"><button class="back-btn" onclick="goBack('welcome')"><i class="fas fa-chevron-left"></i></button></div>
    <div class="logo-area"><div class="app-name" style="font-size:24px;">Tạo tài khoản</div></div>
    
    <div class="input-group">
        <input type="email" id="reg-email" class="lotus-input" placeholder="Email xác thực">
    </div>
    <button class="btn-sub" onclick="checkRegEmail()">Tiếp tục</button>
</div>

<div id="screen-register-pass" class="auth-container hidden">
    <div class="auth-header"><button class="back-btn" onclick="goBack('register-email')"><i class="fas fa-chevron-left"></i></button></div>
    <div class="logo-area"><div class="app-name" style="font-size:24px;">Mật khẩu</div></div>
    
    <div class="input-group">
        <input type="password" id="reg-pass" class="lotus-input" placeholder="Tạo mật khẩu (min 6 ký tự)">
    </div>
    <button class="btn-sub" onclick="checkRegPass()">Tiếp tục</button>
</div>

<div id="screen-register-info" class="auth-container hidden">
    <div class="auth-header"><button class="back-btn" onclick="goBack('register-pass')"><i class="fas fa-chevron-left"></i></button></div>
    <div class="logo-area"><div class="app-name" style="font-size:24px;">Thông tin</div></div>
    
    <div class="input-group">
        <label style="font-size:12px; font-weight:bold; color:#555;">Tên hiển thị</label>
        <input type="text" id="reg-name" class="lotus-input" placeholder="Vd: Minh Tuấn">
    </div>
    <div class="input-group">
        <label style="font-size:12px; font-weight:bold; color:#555;">XingChat ID (Duy nhất)</label>
        <input type="text" id="reg-id" class="lotus-input" placeholder="Vd: tuan123" maxlength="20">
    </div>
    <div id="reg-error" class="error-txt"></div>

    <button class="btn-main" onclick="finishRegistration()">Hoàn tất</button>
</div>

<div id="screen-loading" class="auth-container hidden">
    <div class="spinner"></div>
    <div style="color:#888;">Đang xử lý...</div>
</div>

<div id="main-app">
    <div class="top-header">
        <div style="font-size:24px; font-weight:bold; color:#0084ff;">XingChat</div>
        <i class="fas fa-bell" style="font-size:20px;"></i>
    </div>
    <div id="feed-list" style="padding:10px;"></div>
    <div class="bottom-nav">
        <div class="nav-item active"><i class="fas fa-home"></i></div>
        <div class="nav-item"><i class="fas fa-comment-dots"></i></div>
        <div class="nav-item"><i class="fas fa-user"></i></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, serverTimestamp, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAICFb4QrXY2pDzyuf9u-YF9kX5xlaBss0",
      authDomain: "xingchat-13d44.firebaseapp.com",
      projectId: "xingchat-13d44",
      storageBucket: "xingchat-13d44.firebasestorage.app",
      messagingSenderId: "802782197419",
      appId: "1:802782197419:web:91b50dc75ee978fd0aa9ee"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // Biến tạm cho đăng ký
    let tEmail = "", tPass = "";

    // --- NAVIGATION ---
    window.goToStep = (id) => {
        document.querySelectorAll('.auth-container').forEach(e => e.classList.add('hidden'));
        document.getElementById('screen-' + id).classList.remove('hidden');
    }
    window.goBack = (id) => window.goToStep(id);

    // --- LOGIC ĐĂNG NHẬP (MỚI) ---
    window.doLoginCombined = async () => {
        const email = document.getElementById('login-email').value.trim();
        const pass = document.getElementById('login-pass').value;
        const err = document.getElementById('login-error');

        if(!email || !pass) {
            err.innerText = "Vui lòng nhập đầy đủ Email và Mật khẩu";
            err.style.display = 'block'; return;
        }

        showLoading();
        try {
            await signInWithEmailAndPassword(auth, email, pass);
            // onAuthStateChanged sẽ tự chuyển màn hình
        } catch(e) {
            hideLoading();
            err.innerText = "Sai Email hoặc Mật khẩu!";
            err.style.display = 'block';
        }
    }

    // --- LOGIC QUÊN MẬT KHẨU ---
    window.handleForgotPassword = async () => {
        const email = document.getElementById('forgot-email').value.trim();
        if(!email.includes('@')) return alert("Email không hợp lệ!");

        showLoading();
        try {
            await sendPasswordResetEmail(auth, email);
            hideLoading();
            alert("Đã gửi link đặt lại mật khẩu vào email: " + email + "\nVui lòng kiểm tra hộp thư (cả mục Spam).");
            window.goToStep('login');
        } catch(e) {
            hideLoading();
            alert("Lỗi: " + e.message);
        }
    }

    // --- LOGIC ĐĂNG KÝ (GIỮ NGUYÊN TỪNG BƯỚC) ---
    window.checkRegEmail = () => {
        const e = document.getElementById('reg-email').value.trim();
        if(!e.includes('@')) return alert("Email sai định dạng");
        tEmail = e; window.goToStep('register-pass');
    }
    window.checkRegPass = () => {
        const p = document.getElementById('reg-pass').value;
        if(p.length < 6) return alert("Mật khẩu quá ngắn (min 6)");
        tPass = p; window.goToStep('register-info');
    }
    window.finishRegistration = async () => {
        const name = document.getElementById('reg-name').value.trim();
        const id = document.getElementById('reg-id').value.trim().toLowerCase();
        const err = document.getElementById('reg-error');

        if(!name || !id) return alert("Vui lòng nhập đủ thông tin");
        if(!/^[a-z0-9]{1,20}$/.test(id)) return alert("ID chỉ gồm chữ và số");

        showLoading();
        try {
            const check = await getDoc(doc(db, "ids", id));
            if(check.exists()) throw new Error("ID này đã tồn tại");

            const res = await createUserWithEmailAndPassword(auth, tEmail, tPass);
            await setDoc(doc(db, "users", res.user.uid), {
                email: tEmail, id: id, displayName: name, createdAt: serverTimestamp(), friends:[]
            });
            await setDoc(doc(db, "ids", id), { uid: res.user.uid });
        } catch(e) {
            hideLoading();
            err.innerText = e.message; err.style.display='block';
        }
    }

    // --- SYSTEM ---
    function showLoading() {
        document.querySelectorAll('.auth-container').forEach(e => e.classList.add('hidden'));
        document.getElementById('screen-loading').classList.remove('hidden');
    }
    function hideLoading() { document.getElementById('screen-loading').classList.add('hidden'); }

    onAuthStateChanged(auth, (user) => {
        if(user) {
            showLoading();
            setTimeout(() => {
                document.getElementById('screen-loading').classList.add('hidden');
                document.getElementById('main-app').style.display = 'block';
                loadApp();
            }, 1000);
        } else {
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('screen-welcome').classList.remove('hidden');
        }
    });

    function loadApp() {
        // Code load bài viết demo
        const list = document.getElementById('feed-list');
        onSnapshot(query(collection(db, "posts"), orderBy("createdAt", "desc")), snap => {
            list.innerHTML = "";
            snap.forEach(d => {
                const p = d.data();
                list.innerHTML += `<div class="post-card"><b style="color:#0084ff">${p.author}</b>: ${p.content}</div>`;
            });
        });
    }
</script>
</body>
</html>
