<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XingChat - Lotus Style</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* Màu sắc lấy cảm hứng từ Lotus Chat & XingChat */
            --primary: #8e2de2; 
            --gradient: linear-gradient(to right, #4a00e0, #8e2de2);
            --bg-light: #ffffff;
            --text-main: #333;
            --input-bg: #f2f2f2;
            --btn-radius: 30px;
            
            /* Màu Dark Mode cho Main App */
            --dark-bg: #0f0f0f;
            --dark-card: #1e1e1e;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; background: white; }

        /* --- CÁC MÀN HÌNH AUTH (GIAO DIỆN SÁNG GIỐNG LOTUS) --- */
        .auth-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999;
            display: flex; flex-direction: column; padding: 20px;
            transition: transform 0.3s ease-in-out;
        }

        .auth-header { margin-top: 40px; margin-bottom: 20px; }
        .back-btn { font-size: 24px; color: #333; cursor: pointer; border: none; background: none; padding: 10px 0; }
        
        .logo-area { text-align: center; margin-bottom: 40px; }
        .logo-icon { font-size: 60px; color: #8e2de2; margin-bottom: 10px; }
        .app-name { font-size: 32px; font-weight: 800; background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .welcome-text { text-align: center; color: #666; margin-bottom: 40px; font-size: 15px; padding: 0 20px; }

        .input-group { margin-bottom: 20px; width: 100%; }
        .lotus-input {
            width: 100%; padding: 15px 20px; border-radius: 12px;
            background: var(--input-bg); border: 1px solid transparent;
            font-size: 16px; outline: none; transition: 0.3s;
        }
        .lotus-input:focus { background: white; border-color: #8e2de2; }

        .btn-main {
            width: 100%; padding: 15px; border-radius: var(--btn-radius);
            background: var(--gradient); color: white; font-weight: bold; font-size: 16px;
            border: none; cursor: pointer; margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(138, 43, 226, 0.3);
        }
        .btn-sub {
            width: 100%; padding: 15px; border-radius: var(--btn-radius);
            background: #e6e6e6; color: #333; font-weight: bold; font-size: 16px;
            border: none; cursor: pointer;
        }

        /* --- LOADING SCREEN (GIỐNG ẢNH 4) --- */
        #screen-loading {
            background: white; align-items: center; justify-content: center; text-align: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #8e2de2;
            border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .pulse-logo { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .error-txt { color: red; font-size: 13px; margin-top: 5px; margin-left: 5px; display: none; }
        
        /* --- MAIN APP (GIỮ DARK MODE "XỊN" NHƯ CŨ) --- */
        #main-app {
            display: none; background: var(--dark-bg); min-height: 100vh; color: white; padding-bottom: 80px;
        }
        /* CSS App cũ giữ nguyên để đảm bảo tính năng */
        .top-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; background: rgba(30,30,30,0.9); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100; }
        .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; height: 70px; background: rgba(40,40,40,0.8); backdrop-filter: blur(20px); border-radius: 35px; display: flex; justify-content: space-around; align-items: center; z-index: 999; border: 1px solid rgba(255,255,255,0.1); }
        .nav-item { font-size: 24px; color: #888; cursor: pointer; } .nav-item.active { color: #0084ff; }
        .post-card, .chat-item { background: #1e1e1e; padding: 15px; margin: 10px; border-radius: 15px; }
        .user-ava { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        
    </style>
</head>
<body>

<div id="screen-welcome" class="auth-container">
    <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <div class="logo-icon"><i class="fas fa-comments"></i></div>
        <div class="app-name">XingChat</div>
        <p style="color:#888; margin-top:10px;">Kết nối đam mê, chia sẻ khoảnh khắc</p>
    </div>
    <div class="welcome-text">Đăng nhập hoặc đăng ký tài khoản để bắt đầu sử dụng</div>
    <button class="btn-main" onclick="goToStep('login-email')">Đăng nhập</button>
    <button class="btn-sub" onclick="startRegister()">Đăng ký</button>
    <div style="text-align:center; margin-top:20px; font-size:12px; color:#aaa;">
        Bằng việc đăng nhập/đăng ký, bạn đồng ý với điều khoản sử dụng của XingChat.
    </div>
</div>

<div id="screen-email" class="auth-container hidden">
    <div class="auth-header"><button class="back-btn" onclick="goBack('welcome')"><i class="fas fa-chevron-left"></i></button></div>
    <div class="logo-area">
        <div class="app-name" style="font-size:24px;">XingChat</div>
    </div>
    <div style="text-align:center; margin-bottom:20px; font-size:15px;">Nhập Email để tiếp tục</div>
    <div class="input-group">
        <input type="email" id="inp-email" class="lotus-input" placeholder="Nhập địa chỉ Email">
        <div id="err-email" class="error-txt"></div>
    </div>
    <button class="btn-sub" onclick="checkEmailNext()">Tiếp tục</button>
</div>

<div id="screen-pass" class="auth-container hidden">
    <div class="auth-header"><button class="back-btn" onclick="goBack('email')"><i class="fas fa-chevron-left"></i></button></div>
    <div style="font-size:20px; font-weight:bold; margin-bottom:10px;">Nhập mật khẩu</div>
    <p style="color:#666; font-size:14px; margin-bottom:30px;">Vui lòng nhập mật khẩu cho tài khoản của bạn.</p>
    <div class="input-group">
        <input type="password" id="inp-pass" class="lotus-input" placeholder="Mật khẩu">
        <div id="err-pass" class="error-txt"></div>
    </div>
    <button class="btn-sub" onclick="handleAuthAction()">Hoàn tất</button>
</div>

<div id="screen-profile" class="auth-container hidden">
    <div class="auth-header"><button class="back-btn" onclick="goBack('pass')"><i class="fas fa-chevron-left"></i></button></div>
    <div style="text-align:center; margin-bottom:20px;">
        <img src="https://ui-avatars.com/api/?name=User&background=random" style="width:80px; height:80px; border-radius:50%; margin-bottom:15px;">
        <div style="font-weight:bold; font-size:18px;">Hồ sơ của bạn</div>
    </div>
    
    <div class="input-group">
        <label style="font-size:12px; font-weight:bold; color:#555; margin-left:5px;">Tên hiển thị</label>
        <input type="text" id="inp-name" class="lotus-input" placeholder="Ví dụ: Hùng Nguyễn">
    </div>

    <div class="input-group">
        <label style="font-size:12px; font-weight:bold; color:#555; margin-left:5px;">XingChat ID (Duy nhất)</label>
        <input type="text" id="inp-id" class="lotus-input" placeholder="Ví dụ: hung123" maxlength="20">
        <p style="font-size:11px; color:#888; margin:5px;">* Chỉ dùng chữ và số, tối đa 20 ký tự, không dấu.</p>
        <div id="err-profile" class="error-txt"></div>
    </div>

    <button class="btn-main" onclick="finishRegister()">Vào XingChat ngay</button>
</div>

<div id="screen-loading" class="auth-container hidden">
    <div class="pulse-logo" style="background: var(--gradient); width:80px; height:80px; border-radius:20px; display:flex; align-items:center; justify-content:center; margin-bottom:30px;">
        <i class="fas fa-comments" style="font-size:40px; color:white;"></i>
    </div>
    <div class="app-name" style="margin-bottom:50px;">XingChat</div>
    <div class="spinner"></div>
    <div style="color:#888; font-size:14px;">Đang đăng nhập...</div>
</div>

<div id="main-app">
    <div class="top-header">
        <div style="font-size:24px; font-weight:bold; color:#0084ff;">XingChat</div>
        <i class="fas fa-bell" style="font-size:20px;"></i>
    </div>
    <div id="feed-list" style="padding:10px;"></div>
    
    <div class="bottom-nav">
        <div class="nav-item active"><i class="fas fa-home"></i></div>
        <div class="nav-item"><i class="fas fa-comment-dots"></i></div>
        <div class="nav-item"><i class="fas fa-user"></i></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, serverTimestamp, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAICFb4QrXY2pDzyuf9u-YF9kX5xlaBss0",
      authDomain: "xingchat-13d44.firebaseapp.com",
      projectId: "xingchat-13d44",
      storageBucket: "xingchat-13d44.firebasestorage.app",
      messagingSenderId: "802782197419",
      appId: "1:802782197419:web:91b50dc75ee978fd0aa9ee"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    let isRegistering = false;
    let tempEmail = "";
    let tempPass = "";

    // --- NAVIGATION LOGIC ---
    window.goToStep = (step) => {
        document.querySelectorAll('.auth-container').forEach(el => el.classList.add('hidden'));
        if(step === 'login-email') {
            document.getElementById('screen-email').classList.remove('hidden');
            isRegistering = false;
        } else if (step === 'register-email') {
            document.getElementById('screen-email').classList.remove('hidden');
            isRegistering = true;
        } else {
            document.getElementById('screen-' + step).classList.remove('hidden');
        }
    }

    window.startRegister = () => { isRegistering = true; window.goToStep('register-email'); }
    
    window.goBack = (to) => {
        if(to === 'welcome') {
            document.querySelectorAll('.auth-container').forEach(el => el.classList.add('hidden'));
            document.getElementById('screen-welcome').classList.remove('hidden');
        } else {
            window.goToStep(to);
        }
    }

    // --- FORM HANDLERS ---
    window.checkEmailNext = () => {
        const e = document.getElementById('inp-email').value.trim();
        if(!e.includes('@')) {
            document.getElementById('err-email').innerText = "Email không hợp lệ";
            document.getElementById('err-email').style.display = "block";
            return;
        }
        tempEmail = e;
        document.getElementById('err-email').style.display = "none";
        window.goToStep('pass');
    }

    window.handleAuthAction = () => {
        const p = document.getElementById('inp-pass').value;
        if(p.length < 6) {
            document.getElementById('err-pass').innerText = "Mật khẩu phải từ 6 ký tự";
            document.getElementById('err-pass').style.display = "block";
            return;
        }
        tempPass = p;
        
        if(isRegistering) {
            // Nếu đăng ký -> Qua bước nhập Profile
            window.goToStep('profile');
        } else {
            // Nếu đăng nhập -> Gọi Firebase luôn
            doLogin();
        }
    }

    window.finishRegister = async () => {
        const name = document.getElementById('inp-name').value.trim();
        const id = document.getElementById('inp-id').value.trim().toLowerCase();
        const err = document.getElementById('err-profile');
        
        if(!name) { err.innerText = "Vui lòng nhập tên hiển thị"; err.style.display="block"; return; }
        if(!/^[a-z0-9]{1,20}$/.test(id)) { err.innerText = "ID chỉ chứa chữ thường và số (max 20)"; err.style.display="block"; return; }

        showLoading();
        try {
            // Check ID
            const idDoc = await getDoc(doc(db, "ids", id));
            if(idDoc.exists()) throw new Error("ID này đã có người dùng.");

            // Create Auth
            const res = await createUserWithEmailAndPassword(auth, tempEmail, tempPass);
            
            // Save Data
            await setDoc(doc(db, "users", res.user.uid), {
                email: tempEmail,
                id: id,
                displayName: name,
                createdAt: serverTimestamp(),
                friends: []
            });
            await setDoc(doc(db, "ids", id), { uid: res.user.uid });

            // Auto redirect handled by onAuthStateChanged
        } catch(e) {
            hideLoading();
            alert("Lỗi: " + e.message);
            window.goToStep('profile');
        }
    }

    async function doLogin() {
        showLoading();
        try {
            await signInWithEmailAndPassword(auth, tempEmail, tempPass);
        } catch(e) {
            hideLoading();
            alert("Sai email hoặc mật khẩu!");
            window.goToStep('pass');
        }
    }

    function showLoading() {
        document.querySelectorAll('.auth-container').forEach(el => el.classList.add('hidden'));
        document.getElementById('screen-loading').classList.remove('hidden');
    }
    
    function hideLoading() {
        document.getElementById('screen-loading').classList.add('hidden');
    }

    // --- APP LISTENER ---
    onAuthStateChanged(auth, async (user) => {
        if(user) {
            // Giả vờ loading 1.5s cho đẹp giống app
            showLoading();
            setTimeout(() => {
                document.getElementById('screen-loading').classList.add('hidden');
                document.getElementById('main-app').style.display = 'block';
                loadMainApp(); // Hàm load bài viết, chat (đã có từ code cũ)
            }, 1500);
        } else {
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('screen-welcome').classList.remove('hidden');
        }
    });

    // --- DUMMY FUNCTION ĐỂ APP KHÔNG LỖI (BẠN GIỮ LOGIC APP CŨ VÀO ĐÂY) ---
    function loadMainApp() {
        // Code load bài viết từ phiên bản trước
        const list = document.getElementById('feed-list');
        onSnapshot(query(collection(db, "posts"), orderBy("createdAt", "desc")), snap => {
            list.innerHTML = "";
            snap.forEach(d => {
                const p = d.data();
                list.innerHTML += `<div class="post-card"><b style="color:#0084ff">${p.author}</b>: ${p.content}</div>`;
            });
        });
    }
</script>
</body>
</html>
