<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XingChat - Professional</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #0084ff; /* Messenger Blue */
            --primary-grad: linear-gradient(135deg, #0084ff, #0099ff);
            --bg-light: #ffffff;
            --bg-gray: #f0f2f5;
            --text-main: #050505;
            --text-sub: #65676b;
            --system-color: #ff3b30; /* Màu thương hiệu XingChat */
            
            /* Animation Easing */
            --ease-ios: cubic-bezier(0.32, 0.72, 0, 1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg-light); 
            color: var(--text-main);
            overflow: hidden; 
            height: 100vh;
        }

        /* --- UI COMPONENTS --- */
        .hidden { display: none !important; }
        
        /* 1. INPUT STYLES (MESSENGER STYLE) */
        .pill-input {
            width: 100%;
            padding: 10px 16px;
            border-radius: 99px; /* Bo tròn hoàn toàn */
            background: #f0f2f5;
            border: none;
            font-size: 15px;
            outline: none;
            transition: 0.2s;
        }
        .pill-input:focus { background: #e4e6eb; }

        /* 2. HEADER */
        .header {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            background: white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            z-index: 100;
            position: relative;
        }
        .header-title { font-size: 20px; font-weight: 700; }
        
        /* 3. BOTTOM NAV */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 60px;
            background: white; border-top: 1px solid #eee;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 90;
        }
        .nav-item { 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-sub); width: 100%; height: 100%; cursor: pointer;
        }
        .nav-item i { font-size: 24px; margin-bottom: 4px; transition: 0.2s; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active i { transform: scale(1.1); }

        /* 4. CHAT LIST & CONTENT */
        .container-scroll {
            height: calc(100vh - 120px); /* Minus header & nav */
            overflow-y: auto;
            background: white;
        }

        /* --- ANIMATION SLIDE --- */
        .page-transition {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white;
            transition: transform 0.35s var(--ease-ios);
            z-index: 200;
            display: flex; flex-direction: column;
            transform: translateX(100%); /* Mặc định ẩn bên phải */
        }
        .page-transition.open { transform: translateX(0); }

        /* --- AUTH SCREEN --- */
        .auth-box {
            position: fixed; inset: 0; background: white; z-index: 1000;
            display: flex; flex-direction: column; padding: 30px;
            justify-content: center;
        }
        .btn-primary {
            width: 100%; padding: 14px; border-radius: 99px;
            background: var(--primary); color: white; border: none;
            font-weight: 600; font-size: 16px; margin-top: 15px; cursor: pointer;
        }

        /* --- CHAT BUBBLES --- */
        .msg-list { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; background: white; }
        
        .bubble-row { display: flex; align-items: flex-end; gap: 8px; max-width: 100%; }
        .bubble-row.me { justify-content: flex-end; }
        
        .bubble {
            padding: 10px 14px; 
            border-radius: 18px; 
            font-size: 15px; 
            line-height: 1.4;
            max-width: 75%;
            word-wrap: break-word;
            position: relative;
        }
        /* Style Messenger */
        .bubble-row.me .bubble { background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .bubble-row.them .bubble { background: #f0f2f5; color: black; border-bottom-left-radius: 4px; }
        
        /* Status Text (Sent/Seen) */
        .msg-status {
            font-size: 10px; color: #888; margin-top: 2px; text-align: right;
            margin-right: 5px; opacity: 0.7;
        }

        /* XingChat System Message Style */
        .bubble-row.system .bubble {
            background: #fff0f0; border: 1px solid #ffcccc; color: #d32f2f;
        }
        .system-badge {
            display: inline-block; background: #d32f2f; color: white; 
            font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-bottom: 4px;
        }

        /* --- CHAT INPUT BAR --- */
        .chat-bar {
            padding: 8px 10px; background: white; 
            display: flex; align-items: center; gap: 10px;
            border-top: 1px solid #eee;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
        }
        .send-btn { color: var(--primary); font-size: 20px; cursor: pointer; padding: 5px; }
        
        /* Typing Indicator */
        .typing-indicator {
            font-size: 12px; color: #65676b; font-style: italic;
            position: absolute; bottom: -20px; left: 60px;
            transition: opacity 0.3s; opacity: 0;
        }
        .typing-indicator.show { opacity: 1; }

        /* --- COMMUNITY & SYSTEM TABS --- */
        .post-card {
            padding: 15px; border-bottom: 1px solid #eee;
        }
        .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .post-ava { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .post-name { font-weight: 600; font-size: 15px; }
        .post-time { font-size: 12px; color: #888; }
        
        .sys-logo { width: 40px; height: 40px; border-radius: 8px; background: var(--system-color); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px; }

    </style>
</head>
<body>

<div id="auth-screen" class="auth-box">
    <div style="text-align:center; margin-bottom:40px;">
        <i class="fab fa-facebook-messenger" style="font-size:60px; color:var(--primary); margin-bottom:20px;"></i>
        <h1 style="margin:0; font-size:28px;">XingChat</h1>
        <p style="color:#888;">Kết nối cộng đồng</p>
    </div>
    
    <div id="login-form">
        <input type="email" id="email" class="pill-input" placeholder="Email" style="margin-bottom:10px;">
        <input type="password" id="pass" class="pill-input" placeholder="Mật khẩu" style="margin-bottom:10px;">
        <button class="btn-primary" onclick="handleLogin()">Đăng nhập</button>
        <div style="text-align:center; margin-top:20px; color:var(--primary); cursor:pointer;" onclick="toggleAuthMode()">Chưa có tài khoản? Đăng ký</div>
    </div>
    
    <div id="reg-form" class="hidden">
        <input type="text" id="r-name" class="pill-input" placeholder="Tên hiển thị" style="margin-bottom:10px;">
        <input type="text" id="r-id" class="pill-input" placeholder="ID (Vd: tuan123)" style="margin-bottom:10px;">
        <input type="email" id="r-email" class="pill-input" placeholder="Email" style="margin-bottom:10px;">
        <input type="password" id="r-pass" class="pill-input" placeholder="Mật khẩu (min 6 ký tự)" style="margin-bottom:10px;">
        <button class="btn-primary" onclick="handleReg()">Đăng ký</button>
        <div style="text-align:center; margin-top:20px; color:var(--text-sub); cursor:pointer;" onclick="toggleAuthMode()">Quay lại Đăng nhập</div>
    </div>
</div>

<div id="app-screen" class="hidden">
    
    <div id="tab-community">
        <div class="header">
            <div class="header-title">Cộng đồng</div>
            <i class="fas fa-users" style="color:var(--primary);"></i>
        </div>
        <div id="com-list" class="container-scroll" style="padding-bottom: 80px;">
            </div>
        <div id="com-input-area" class="chat-bar hidden" style="position:fixed; bottom:60px; width:100%;">
            <input type="text" id="com-inp" class="pill-input" placeholder="Admin thông báo...">
            <i class="fas fa-paper-plane send-btn" onclick="sendCommunity()"></i>
        </div>
    </div>

    <div id="tab-chats" class="hidden">
        <div class="header">
            <div class="header-title">Đoạn chat</div>
            <i class="fas fa-edit" style="color:var(--primary);"></i>
        </div>
        <div style="padding:10px 16px;">
            <div style="position:relative;">
                <i class="fas fa-search" style="position:absolute; left:12px; top:10px; color:#888;"></i>
                <input type="text" class="pill-input" style="padding-left:35px;" placeholder="#Id người dùng" oninput="searchUser(this.value)">
            </div>
            <div id="search-res" style="margin-top:10px;"></div>
        </div>
        <div id="chat-list" class="container-scroll">
            </div>
    </div>

    <div id="tab-system" class="hidden">
        <div class="header" style="background:#fff0f0;">
            <div class="header-title" style="color:#d32f2f;">XingChat</div>
            <i class="fas fa-shield-alt" style="color:#d32f2f;"></i>
        </div>
        <div id="sys-list" class="container-scroll" style="padding-bottom: 80px;">
            </div>
        <div id="sys-input-area" class="chat-bar hidden" style="position:fixed; bottom:60px; width:100%; background:#fff0f0;">
            <input type="text" id="sys-inp" class="pill-input" placeholder="Gửi thông báo hệ thống...">
            <i class="fas fa-paper-plane send-btn" style="color:#d32f2f;" onclick="sendSystem()"></i>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('community', this)">
            <i class="fas fa-globe-asia"></i>
            <span style="font-size:10px;">Cộng đồng</span>
        </div>
        <div class="nav-item" onclick="switchTab('chats', this)">
            <i class="fab fa-facebook-messenger"></i>
            <span style="font-size:10px;">Tin nhắn</span>
        </div>
        <div class="nav-item" onclick="switchTab('system', this)">
            <i class="fas fa-bullhorn"></i>
            <span style="font-size:10px;">Hệ thống</span>
        </div>
    </div>
</div>

<div id="chat-window" class="page-transition">
    <div class="header">
        <i class="fas fa-chevron-left" style="font-size:24px; color:var(--primary); cursor:pointer;" onclick="closeChat()"></i>
        <div style="flex:1; text-align:center;">
            <div id="cw-name" style="font-weight:700; font-size:16px;">User</div>
            <div id="cw-status" style="font-size:11px; color:#4dbd74; display:none;">Đang hoạt động</div>
            <div id="cw-typing" class="hidden" style="font-size:11px; color:#888;">Đang nhập văn bản...</div>
        </div>
        <div style="width:24px;"></div> </div>

    <div id="cw-msgs" class="msg-list"></div>

    <div class="chat-bar">
        <input type="text" id="cw-inp" class="pill-input" placeholder="Nhắn tin..." onkeydown="if(event.key==='Enter') sendMsg()" oninput="handleTyping()">
        <i class="fas fa-paper-plane send-btn" onclick="sendMsg()"></i>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, serverTimestamp, collection, query, orderBy, onSnapshot, updateDoc, arrayUnion, addDoc, where } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // --- CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyAICFb4QrXY2pDzyuf9u-YF9kX5xlaBss0",
      authDomain: "xingchat-13d44.firebaseapp.com",
      projectId: "xingchat-13d44",
      storageBucket: "xingchat-13d44.firebasestorage.app",
      messagingSenderId: "802782197419",
      appId: "1:802782197419:web:91b50dc75ee978fd0aa9ee"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const ADMIN_EMAIL = "nguyentienhunglci@gmail.com";
    let currentUser = null;
    let currentChatId = null;
    let typingTimeout = null;

    // --- AUTH LOGIC ---
    window.toggleAuthMode = () => {
        document.getElementById('login-form').classList.toggle('hidden');
        document.getElementById('reg-form').classList.toggle('hidden');
    }

    window.handleLogin = async () => {
        const e = document.getElementById('email').value;
        const p = document.getElementById('pass').value;
        if(!e||!p) return alert("Vui lòng nhập đủ thông tin");
        try { await signInWithEmailAndPassword(auth, e, p); }
        catch(err) { alert("Lỗi đăng nhập: " + err.message); }
    }

    window.handleReg = async () => {
        const n = document.getElementById('r-name').value;
        const i = document.getElementById('r-id').value.toLowerCase();
        const e = document.getElementById('r-email').value;
        const p = document.getElementById('r-pass').value;
        
        if(!n||!i||!e||!p) return alert("Thiếu thông tin");
        
        try {
            // Check ID
            const idDoc = await getDoc(doc(db, "ids", i));
            if(idDoc.exists()) throw new Error("ID này đã có người dùng.");

            const res = await createUserWithEmailAndPassword(auth, e, p);
            const uid = res.user.uid;

            // Create User & ID mapping
            await setDoc(doc(db, "users", uid), {
                uid: uid,
                displayName: n,
                id: i,
                email: e,
                friends: [],
                avatar: `https://ui-avatars.com/api/?name=${n}&background=0084ff&color=fff`,
                createdAt: serverTimestamp()
            });
            await setDoc(doc(db, "ids", i), { uid: uid });

        } catch(err) { alert(err.message); }
    }

    onAuthStateChanged(auth, async (user) => {
        if(user) {
            const uDoc = await getDoc(doc(db, "users", user.uid));
            if(uDoc.exists()) {
                currentUser = uDoc.data();
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                
                initApp();
            }
        } else {
            currentUser = null;
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('app-screen').classList.add('hidden');
        }
    });

    // --- APP LOGIC ---
    function initApp() {
        // 1. Permission Check for Input Areas
        if(currentUser.email === ADMIN_EMAIL) {
            document.getElementById('com-input-area').classList.remove('hidden');
            document.getElementById('sys-input-area').classList.remove('hidden');
        } else {
            document.getElementById('com-input-area').classList.add('hidden');
            document.getElementById('sys-input-area').classList.add('hidden');
        }

        // 2. Load Data
        loadCommunity();
        loadSystemMessages();
        loadFriendList();
    }

    // --- NAVIGATION ---
    window.switchTab = (tabId, el) => {
        // Update Nav UI
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        el.classList.add('active');

        // Hide all tabs
        ['tab-community', 'tab-chats', 'tab-system'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });

        // Show selected
        document.getElementById('tab-' + tabId).classList.remove('hidden');
    }

    // --- TAB 1: COMMUNITY (Admin send -> All read) ---
    function loadCommunity() {
        onSnapshot(query(collection(db, "community_chat"), orderBy("createdAt", "desc")), snap => {
            const list = document.getElementById('com-list');
            list.innerHTML = "";
            snap.forEach(d => {
                const m = d.data();
                const div = document.createElement('div');
                div.className = "post-card";
                div.innerHTML = `
                    <div class="post-header">
                        <img src="${m.avatar}" class="post-ava">
                        <div>
                            <div class="post-name">${m.author} ${m.isAdmin ? '<i class="fas fa-check-circle" style="color:#0084ff; font-size:12px;"></i>' : ''}</div>
                            <div class="post-time">Vừa xong</div>
                        </div>
                    </div>
                    <div style="font-size:15px; line-height:1.4;">${m.content}</div>
                `;
                list.appendChild(div);
            });
        });
    }

    window.sendCommunity = async () => {
        const inp = document.getElementById('com-inp');
        const txt = inp.value.trim();
        if(!txt) return;
        
        await addDoc(collection(db, "community_chat"), {
            uid: currentUser.uid,
            author: currentUser.displayName,
            avatar: currentUser.avatar,
            content: txt,
            isAdmin: true,
            createdAt: serverTimestamp()
        });
        inp.value = "";
    }

    // --- TAB 3: SYSTEM (XingChat Branding) ---
    function loadSystemMessages() {
        onSnapshot(query(collection(db, "system_chat"), orderBy("createdAt", "desc")), snap => {
            const list = document.getElementById('sys-list');
            list.innerHTML = "";
            snap.forEach(d => {
                const m = d.data();
                const div = document.createElement('div');
                div.className = "post-card";
                div.innerHTML = `
                    <div class="post-header">
                        <div class="sys-logo">X</div>
                        <div>
                            <div class="post-name" style="color:#d32f2f;">XingChat <i class="fas fa-shield-alt"></i></div>
                            <div class="post-time" style="font-size:11px;">Thông báo hệ thống</div>
                        </div>
                    </div>
                    <div style="font-size:15px; line-height:1.4; color:#333;">${m.content}</div>
                `;
                list.appendChild(div);
            });
        });
    }

    window.sendSystem = async () => {
        if(currentUser.email !== ADMIN_EMAIL) return; // Bảo mật lớp 2
        
        const inp = document.getElementById('sys-inp');
        const txt = inp.value.trim();
        if(!txt) return;

        // Branding: Luôn gửi dưới tên XingChat
        await addDoc(collection(db, "system_chat"), {
            uid: "SYSTEM",
            author: "XingChat",
            content: txt,
            createdAt: serverTimestamp()
        });
        inp.value = "";
    }

    // --- TAB 2: PRIVATE CHAT (Messenger Logic) ---
    window.searchUser = async (val) => {
        const res = document.getElementById('search-res');
        res.innerHTML = "";
        if(!val || val.length < 3) return;

        const idRef = doc(db, "ids", val.toLowerCase());
        const idSnap = await getDoc(idRef);

        if(idSnap.exists()) {
            const targetUid = idSnap.data().uid;
            if(targetUid === currentUser.uid) return;

            res.innerHTML = `
                <div style="display:flex; align-items:center; background:#f0f2f5; padding:10px; border-radius:10px;" onclick="addFriend('${targetUid}')">
                    <div style="flex:1;"><b>${val}</b></div>
                    <div style="color:var(--primary); font-weight:bold;">Thêm</div>
                </div>
            `;
        }
    }

    window.addFriend = async (uid) => {
        await updateDoc(doc(db, "users", currentUser.uid), { friends: arrayUnion(uid) });
        await updateDoc(doc(db, "users", uid), { friends: arrayUnion(currentUser.uid) });
        document.getElementById('search-res').innerHTML = "<div style='color:green'>Đã kết bạn!</div>";
    }

    function loadFriendList() {
        onSnapshot(doc(db, "users", currentUser.uid), async (snap) => {
            const friends = snap.data().friends || [];
            const list = document.getElementById('chat-list');
            list.innerHTML = "";

            for(const fid of friends) {
                const fDoc = await getDoc(doc(db, "users", fid));
                if(fDoc.exists()) {
                    const f = fDoc.data();
                    const el = document.createElement('div');
                    el.style = "display:flex; align-items:center; padding:12px 16px; gap:12px; cursor:pointer;";
                    el.onclick = () => openChat(f);
                    el.innerHTML = `
                        <img src="${f.avatar}" style="width:50px; height:50px; border-radius:50%;">
                        <div>
                            <div style="font-weight:600; font-size:16px;">${f.displayName}</div>
                            <div style="font-size:13px; color:#888;">Nhấn để trò chuyện</div>
                        </div>
                    `;
                    list.appendChild(el);
                }
            }
        });
    }

    // --- CHAT WINDOW LOGIC ---
    let unsubscribeChat = null;

    window.openChat = (friend) => {
        currentChatId = [currentUser.uid, friend.uid].sort().join("_");
        
        // UI Updates
        document.getElementById('cw-name').innerText = friend.displayName;
        document.getElementById('chat-window').classList.add('open');
        document.getElementById('cw-msgs').innerHTML = '<div style="text-align:center; padding:20px; color:#888;">Đang tải tin nhắn...</div>';

        // Load Messages
        if(unsubscribeChat) unsubscribeChat();
        const q = query(collection(db, "chats", currentChatId, "msgs"), orderBy("createdAt", "asc"));
        
        unsubscribeChat = onSnapshot(q, snap => {
            const box = document.getElementById('cw-msgs');
            box.innerHTML = "";
            snap.forEach(d => {
                const m = d.data();
                const isMe = m.uid === currentUser.uid;
                
                // Status Logic (Giả lập)
                let statusText = "";
                if(isMe) statusText = "Đã gửi"; 

                const div = document.createElement('div');
                div.className = `bubble-row ${isMe ? 'me' : 'them'}`;
                div.innerHTML = `
                    <div>
                        <div class="bubble">${m.txt}</div>
                        ${isMe ? `<div class="msg-status">${statusText}</div>` : ''}
                    </div>
                `;
                box.appendChild(div);
            });
            // Auto Scroll
            box.scrollTop = box.scrollHeight;
        });
    }

    window.closeChat = () => {
        document.getElementById('chat-window').classList.remove('open');
        if(unsubscribeChat) unsubscribeChat();
        currentChatId = null;
    }

    window.sendMsg = async () => {
        const inp = document.getElementById('cw-inp');
        const txt = inp.value.trim();
        if(!txt || !currentChatId) return;

        inp.value = ""; // Clear UI immediately for speed
        
        await addDoc(collection(db, "chats", currentChatId, "msgs"), {
            uid: currentUser.uid,
            txt: txt,
            createdAt: serverTimestamp()
        });
    }

    // --- TYPING ANIMATION (Simulation) ---
    window.handleTyping = () => {
        // Logic thực tế cần update lên Firebase, ở đây demo UI
        // Khi đối phương gõ (cần backend trigger), hiển thị:
        // document.getElementById('cw-typing').classList.remove('hidden');
    }

</script>
</body>
</html>
