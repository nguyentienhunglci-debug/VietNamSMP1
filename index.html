<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XingChat Community</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* MÀU AUTH (LOTUS STYLE) */
            --primary: #8e2de2; 
            --gradient: linear-gradient(to right, #4a00e0, #8e2de2);
            --bg-light: #ffffff;
            --input-bg: #f2f2f2;
            
            /* MÀU APP (DARK MODE) */
            --app-primary: #0084ff;
            --dark-bg: #0f0f0f;
            --dark-card: #1e1e1e;
            --dark-input: #2a2a2a;
            --text-white: #ffffff;
            --text-gray: #b0b3b8;
            --msg-bubble-me: #0084ff;
            --msg-bubble-them: #2a2a2a;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; background: white; }

        /* --- 1. CSS CHO PHẦN ĐĂNG NHẬP --- */
        .auth-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999;
            display: flex; flex-direction: column; padding: 20px;
            transition: transform 0.3s ease-in-out;
            overflow-y: auto;
        }
        .auth-header { margin-top: 10px; margin-bottom: 20px; }
        .back-btn { font-size: 24px; color: #333; cursor: pointer; border: none; background: none; }
        .app-name { font-size: 28px; font-weight: 800; background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .lotus-input {
            width: 100%; padding: 15px 20px; border-radius: 12px; margin-bottom: 15px;
            background: var(--input-bg); border: 1px solid transparent; font-size: 16px; outline: none;
        }
        .lotus-input:focus { background: white; border-color: #8e2de2; }
        .btn-main {
            width: 100%; padding: 15px; border-radius: 30px; background: var(--gradient); color: white;
            font-weight: bold; font-size: 16px; border: none; cursor: pointer; margin-top: 10px;
        }
        .btn-sub {
            width: 100%; padding: 15px; border-radius: 30px; background: #e6e6e6; color: #333;
            font-weight: bold; font-size: 16px; border: none; cursor: pointer; margin-top: 10px;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #8e2de2; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- 2. CSS CHO APP CHÍNH (TỐI) --- */
        #main-app { display: none; background: var(--dark-bg); width: 100%; height: 100vh; color: var(--text-white); padding-bottom: 80px; }
        
        .top-header {
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(15,15,15,0.95); z-index: 100;
            backdrop-filter: blur(10px); border-bottom: 1px solid #333; height: 60px;
        }
        
        .bottom-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; height: 65px;
            background: rgba(30,30,30,0.85); backdrop-filter: blur(20px);
            border-radius: 35px; display: flex; justify-content: space-around; align-items: center;
            z-index: 999; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .nav-item { font-size: 22px; color: #888; cursor: pointer; transition: 0.3s; position: relative; }
        .nav-item.active { color: var(--app-primary); transform: translateY(-3px); }
        .nav-item.active::after {
            content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
            width: 5px; height: 5px; background: var(--app-primary); border-radius: 50%;
        }

        .hidden { display: none !important; }
        
        /* CHAT CỘNG ĐỒNG & RIÊNG */
        .chat-container { flex: 1; display: flex; flex-direction: column; height: calc(100vh - 140px); overflow: hidden; position: relative; }
        .chat-list-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; scroll-behavior: smooth; }
        .chat-input-area { 
            padding: 10px; background: var(--dark-bg); display: flex; align-items: center; 
            border-top: 1px solid #333; position: absolute; bottom: 0; width: 100%;
        }
        
        /* Message Bubble Styles */
        .msg-row { display: flex; align-items: flex-end; gap: 8px; margin-bottom: 5px; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .msg-ava { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; cursor: pointer; border: 1px solid #444; }
        .msg-bubble { 
            padding: 10px 14px; border-radius: 18px; font-size: 15px; line-height: 1.4; max-width: 75%; word-wrap: break-word; position: relative;
        }
        .msg-row.me { justify-content: flex-end; }
        .msg-row.me .msg-bubble { background: var(--msg-bubble-me); color: white; border-bottom-right-radius: 4px; }
        .msg-row.them .msg-bubble { background: var(--msg-bubble-them); color: white; border-bottom-left-radius: 4px; }
        .msg-name { font-size: 11px; color: #888; margin-bottom: 2px; margin-left: 10px; }

        /* TAB THÔNG BÁO (NOTIFICATION) */
        .notify-item {
            background: var(--dark-bg); padding: 15px; display: flex; align-items: center; gap: 15px;
            border-bottom: 1px solid #222; cursor: pointer; transition: 0.2s;
        }
        .notify-item:active { background: #1a1a1a; }
        .notify-icon { width: 45px; height: 45px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 20px; }
        .noti-lotus { background: #e8f5fe; color: #0084ff; }
        .noti-admin { background: #fef2f2; color: #ff4757; }
        .noti-content h4 { margin: 0; font-size: 16px; display: flex; align-items: center; gap: 5px; }
        .noti-content p { margin: 4px 0 0; font-size: 13px; color: #888; line-height: 1.3; }
        .blue-tick { color: #0084ff; font-size: 12px; }

        /* USER OPTIONS MODAL */
        #user-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6);
            z-index: 6000; display: none; align-items: center; justify-content: center;
            animation: fadeIn 0.2s;
        }
        .modal-content {
            background: #252525; width: 80%; max-width: 300px; border-radius: 20px; padding: 20px; text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); transform: scale(0.9); animation: popIn 0.2s forwards;
        }
        @keyframes popIn { to { transform: scale(1); } }
        .modal-ava { width: 70px; height: 70px; border-radius: 50%; margin-bottom: 10px; border: 3px solid var(--app-primary); }
        .modal-btn {
            width: 100%; padding: 12px; margin-top: 10px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; font-size: 15px;
        }
        .btn-chat { background: var(--app-primary); color: white; }
        .btn-hide { background: #3a3a3a; color: #ff4757; }
        
        /* CHAT WINDOW (PRIVATE) */
        .chat-window { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark-bg); z-index: 5000; display: none; flex-direction: column; }
        
        /* Input chung */
        .chat-inp-group { flex: 1; background: #333; border-radius: 20px; padding: 5px 15px; display: flex; align-items: center; }
        .chat-inp-group input { flex: 1; background: transparent; border: none; color: white; padding: 8px 0; outline: none; font-size: 16px; }
        .chat-inp-group i { color: #888; font-size: 18px; margin-right: 10px; }
        .send-btn { color: var(--app-primary); font-size: 22px; padding: 10px; cursor: pointer; margin-left: 5px; }

        /* Search & Chat List (Private Tab) */
        .search-box { background: var(--dark-input); padding: 10px 15px; border-radius: 15px; display: flex; gap: 10px; align-items: center; margin: 15px; }
        .chat-item { display: flex; align-items: center; padding: 12px 15px; gap: 15px; margin: 0 10px; border-radius: 15px; }
    </style>
</head>
<body>

<div id="screen-welcome" class="auth-container">
    <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <i class="fas fa-comments" style="font-size:60px; color:#8e2de2; margin-bottom:15px;"></i>
        <div class="app-name">XingChat</div>
        <p style="color:#888;">Kết nối đam mê</p>
    </div>
    <button class="btn-main" onclick="goToStep('login')">Đăng nhập</button>
    <button class="btn-sub" onclick="goToStep('register-email')">Đăng ký</button>
</div>

<div id="screen-login" class="auth-container hidden">
    <div class="auth-header"><button class="back-btn" onclick="goBack('welcome')"><i class="fas fa-chevron-left"></i></button></div>
    <div style="text-align:center; margin-bottom:30px;"><div class="app-name" style="font-size:24px;">Đăng nhập</div></div>
    <input type="email" id="login-email" class="lotus-input" placeholder="Email">
    <input type="password" id="login-pass" class="lotus-input" placeholder="Mật khẩu">
    <div style="text-align:right; margin-bottom:20px;"><span onclick="goToStep('forgot')" style="color:#8e2de2; font-weight:bold; cursor:pointer;">Quên mật khẩu?</span></div>
    <button class="btn-main" onclick="doLogin()">Đăng nhập</button>
</div>

<div id="screen-forgot" class="auth-container hidden">
    <div class="auth-header"><button class="back-btn" onclick="goBack('login')"><i class="fas fa-chevron-left"></i></button></div>
    <div style="text-align:center; margin-bottom:20px;"><div class="app-name" style="font-size:24px;">Khôi phục mật khẩu</div></div>
    <input type="email" id="forgot-email" class="lotus-input" placeholder="Nhập Email">
    <button class="btn-main" onclick="handleForgot()">Gửi liên kết</button>
</div>

<div id="screen-register-email" class="auth-container hidden">
    <div class="auth-header"><button class="back-btn" onclick="goBack('welcome')"><i class="fas fa-chevron-left"></i></button></div>
    <input type="email" id="reg-email" class="lotus-input" placeholder="Email xác thực">
    <button class="btn-sub" onclick="checkRegEmail()">Tiếp tục</button>
</div>
<div id="screen-register-pass" class="auth-container hidden">
    <div class="auth-header"><button class="back-btn" onclick="goBack('register-email')"><i class="fas fa-chevron-left"></i></button></div>
    <input type="password" id="reg-pass" class="lotus-input" placeholder="Tạo mật khẩu (min 6 ký tự)">
    <button class="btn-sub" onclick="checkRegPass()">Tiếp tục</button>
</div>
<div id="screen-register-info" class="auth-container hidden">
    <div class="auth-header"><button class="back-btn" onclick="goBack('register-pass')"><i class="fas fa-chevron-left"></i></button></div>
    <input type="text" id="reg-name" class="lotus-input" placeholder="Tên hiển thị">
    <input type="text" id="reg-id" class="lotus-input" placeholder="ID (Vd: tuan123)" maxlength="20">
    <button class="btn-main" onclick="finishReg()">Hoàn tất</button>
</div>

<div id="screen-loading" class="auth-container hidden" style="justify-content:center; align-items:center;">
    <div class="spinner"></div><div style="color:#888;">Đang xử lý...</div>
</div>

<div id="main-app">
    <div id="tab-community" style="height:100%;">
        <div class="top-header">
            <div style="font-size:20px; font-weight:bold; display:flex; align-items:center; gap:10px;">
                <i class="fas fa-globe-asia" style="color:var(--app-primary);"></i> Chat Cộng Đồng
            </div>
            <div style="font-size:12px; color:gray;">Trực tuyến</div>
        </div>
        
        <div class="chat-container">
            <div id="com-list" class="chat-list-area"></div>
            <div class="chat-input-area">
                <div class="chat-inp-group">
                    <input type="text" id="com-inp" placeholder="Nhập tin nhắn..." onkeydown="if(event.key==='Enter') sendComMsg()">
                </div>
                <i class="fas fa-paper-plane send-btn" onclick="sendComMsg()"></i>
            </div>
        </div>
    </div>

    <div id="tab-chat" class="hidden" style="height:100%;">
        <div class="top-header">
            <div style="font-size:22px; font-weight:bold;">Tin nhắn</div>
            <i class="fas fa-edit" style="font-size:20px;"></i>
        </div>
        <div class="search-box">
            <i class="fas fa-search" style="color:gray;"></i>
            <input type="text" placeholder="Tìm ID bạn bè..." oninput="searchUser(this.value)" style="background:transparent; border:none; color:white; flex:1; outline:none;">
        </div>
        <div id="search-results" style="padding:0 15px;"></div>
        <div id="chat-list" style="padding-bottom:10px;"></div>
    </div>

    <div id="tab-notify" class="hidden" style="height:100%;">
        <div class="top-header">
            <div style="font-size:22px; font-weight:bold;">Thông báo</div>
            <div style="font-size:14px; color:var(--app-primary); cursor:pointer;" onclick="logout()">Đăng xuất</div>
        </div>
        <div id="notify-list" style="padding-top:10px;">
            <div class="notify-item">
                <div class="notify-icon noti-lotus"><i class="fas fa-shield-alt"></i></div>
                <div class="noti-content">
                    <h4>XingChat Security <i class="fas fa-check-circle blue-tick"></i></h4>
                    <p>Chào mừng bạn đến với XingChat! Tài khoản của bạn đã được bảo vệ.</p>
                </div>
            </div>
            <div class="notify-item">
                <div class="notify-icon noti-admin"><i class="fas fa-bullhorn"></i></div>
                <div class="noti-content">
                    <h4>Admin Thông Báo <i class="fas fa-check-circle blue-tick"></i></h4>
                    <p>Phiên bản V2 đã cập nhật tính năng Chat Cộng Đồng và Ẩn tin nhắn.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('community')"><i class="fas fa-users"></i></div>
        <div class="nav-item" onclick="switchTab('chat')"><i class="fas fa-comment-dots"></i></div>
        <div class="nav-item" onclick="switchTab('notify')"><i class="fas fa-bell"></i></div>
    </div>
</div>

<div id="user-modal" onclick="closeModal(event)">
    <div class="modal-content">
        <img id="modal-ava" class="modal-ava" src="">
        <h3 id="modal-name" style="margin:5px 0;">Name</h3>
        <p style="color:gray; font-size:12px; margin-bottom:15px;">Chọn hành động</p>
        
        <button class="modal-btn btn-chat" onclick="actionPrivateChat()">Nhắn tin riêng</button>
        <button class="modal-btn btn-hide" onclick="actionHideUser()">Ẩn tin nhắn người này</button>
    </div>
</div>

<div id="chat-window" class="chat-window">
    <div style="padding:15px; background:rgba(30,30,30,0.95); display:flex; align-items:center; border-bottom:1px solid #333;">
        <i class="fas fa-chevron-left" onclick="closeChat()" style="font-size:24px; padding:10px; cursor:pointer;"></i>
        <b id="cw-name" style="font-size:18px; margin-left:10px;">User</b>
    </div>
    <div id="cw-msgs" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:10px;"></div>
    <div style="padding:10px; background:#1e1e1e; display:flex; align-items:center;">
        <label for="img-up" style="padding:10px;"><i class="fas fa-image" style="font-size:24px; color:var(--app-primary);"></i></label>
        <input type="file" id="img-up" hidden accept="image/*" onchange="sendImage(this)">
        <div class="chat-inp-group" style="margin:0 5px;">
            <input id="cw-inp" type="text" placeholder="Nhắn tin...">
        </div>
        <i class="fas fa-paper-plane send-btn" onclick="sendMsg()"></i>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, serverTimestamp, collection, query, orderBy, onSnapshot, updateDoc, arrayUnion, addDoc, where } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";

    // CONFIG 13d44
    const firebaseConfig = {
      apiKey: "AIzaSyAICFb4QrXY2pDzyuf9u-YF9kX5xlaBss0",
      authDomain: "xingchat-13d44.firebaseapp.com",
      projectId: "xingchat-13d44",
      storageBucket: "xingchat-13d44.firebasestorage.app",
      messagingSenderId: "802782197419",
      appId: "1:802782197419:web:91b50dc75ee978fd0aa9ee"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    
    let me = null;
    let activeChatID = null;
    let tEmail="", tPass="";
    
    // Local Block List
    let hiddenUsers = JSON.parse(localStorage.getItem('xingchat_hidden_users') || "[]");
    let selectedUser = null; // For modal

    // --- AUTH ---
    window.goToStep = (id) => {
        document.querySelectorAll('.auth-container').forEach(e=>e.classList.add('hidden'));
        document.getElementById('screen-'+id).classList.remove('hidden');
    }
    window.goBack = (id) => window.goToStep(id);
    window.doLogin = async () => {
        const e = document.getElementById('login-email').value;
        const p = document.getElementById('login-pass').value;
        if(!e||!p) return alert("Nhập thiếu thông tin");
        document.getElementById('screen-loading').classList.remove('hidden');
        try { await signInWithEmailAndPassword(auth,e,p); }
        catch(err) { document.getElementById('screen-loading').classList.add('hidden'); alert("Sai thông tin!"); }
    }
    window.handleForgot = async () => {
        const e = document.getElementById('forgot-email').value;
        try { await sendPasswordResetEmail(auth,e); alert("Đã gửi mail!"); window.goToStep('login'); } catch(e){alert(e.message);}
    }
    window.checkRegEmail = () => { tEmail=document.getElementById('reg-email').value; if(tEmail.includes('@')) window.goToStep('register-pass'); else alert("Email sai"); }
    window.checkRegPass = () => { tPass=document.getElementById('reg-pass').value; if(tPass.length>=6) window.goToStep('register-info'); else alert("Pass ngắn"); }
    window.finishReg = async () => {
        const name = document.getElementById('reg-name').value;
        const id = document.getElementById('reg-id').value.toLowerCase();
        if(!name||!id) return alert("Thiếu thông tin");
        document.getElementById('screen-loading').classList.remove('hidden');
        try {
            if((await getDoc(doc(db,"ids",id))).exists()) throw new Error("ID đã tồn tại");
            const res = await createUserWithEmailAndPassword(auth,tEmail,tPass);
            await setDoc(doc(db,"users",res.user.uid), { email:tEmail, id:id, displayName:name, friends:[], createdAt:serverTimestamp() });
            await setDoc(doc(db,"ids",id), { uid:res.user.uid });
        } catch(e) { document.getElementById('screen-loading').classList.add('hidden'); alert(e.message); }
    }
    window.logout = () => signOut(auth);

    onAuthStateChanged(auth, async (user) => {
        if(user) {
            document.querySelectorAll('.auth-container').forEach(e=>e.classList.add('hidden'));
            const snap = await getDoc(doc(db,"users",user.uid));
            if(snap.exists()) {
                me = { uid:user.uid, ...snap.data() };
                document.getElementById('main-app').style.display='block';
                loadCommunityChat(); loadChatList();
            }
        } else {
            document.getElementById('main-app').style.display='none';
            document.getElementById('screen-welcome').classList.remove('hidden');
        }
    });

    // --- TABS ---
    window.switchTab = (tab) => {
        document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
        ['tab-community','tab-chat','tab-notify'].forEach(id=>document.getElementById(id).classList.add('hidden'));
        if(tab==='community'){ document.querySelectorAll('.nav-item')[0].classList.add('active'); document.getElementById('tab-community').classList.remove('hidden'); scrollComBottom(); }
        else if(tab==='chat'){ document.querySelectorAll('.nav-item')[1].classList.add('active'); document.getElementById('tab-chat').classList.remove('hidden'); }
        else { document.querySelectorAll('.nav-item')[2].classList.add('active'); document.getElementById('tab-notify').classList.remove('hidden'); }
    }

    // --- COMMUNITY CHAT ---
    function loadCommunityChat() {
        onSnapshot(query(collection(db,"community_chat"), orderBy("createdAt","asc")), snap => {
            const list = document.getElementById('com-list'); list.innerHTML="";
            snap.forEach(d => {
                const m = d.data();
                if(hiddenUsers.includes(m.uid)) return; // Filter hidden users
                
                const isMe = m.uid === me.uid;
                const ava = `https://ui-avatars.com/api/?name=${m.author}&background=random`;
                
                const div = document.createElement('div');
                div.className = `msg-row ${isMe ? 'me' : 'them'}`;
                
                let contentHTML = `<div class="msg-bubble">${m.content}</div>`;
                if(!isMe) contentHTML = `
                    <img src="${ava}" class="msg-ava" onclick="showUserMenu('${m.uid}','${m.author}','${ava}')">
                    <div>
                        <div class="msg-name">${m.author}</div>
                        <div class="msg-bubble">${m.content}</div>
                    </div>`;
                
                div.innerHTML = contentHTML;
                list.appendChild(div);
            });
            scrollComBottom();
        });
    }
    window.sendComMsg = async () => {
        const c = document.getElementById('com-inp').value; if(!c.trim()) return;
        document.getElementById('com-inp').value = "";
        await addDoc(collection(db,"community_chat"), { uid:me.uid, author:me.displayName, content:c, createdAt:serverTimestamp() });
        scrollComBottom();
    }
    function scrollComBottom() {
        const d = document.getElementById('com-list'); d.scrollTop = d.scrollHeight;
    }

    // --- USER MODAL & ACTIONS ---
    window.showUserMenu = (uid, name, ava) => {
        if(uid === me.uid) return;
        selectedUser = { uid, name };
        document.getElementById('modal-ava').src = ava;
        document.getElementById('modal-name').innerText = name;
        document.getElementById('user-modal').style.display = 'flex';
    }
    window.closeModal = (e) => {
        if(e.target.id === 'user-modal') document.getElementById('user-modal').style.display = 'none';
    }
    window.actionPrivateChat = () => {
        document.getElementById('user-modal').style.display = 'none';
        // Check if friend, if not just open chat directly (simple version)
        openChat(selectedUser.uid, selectedUser.name);
    }
    window.actionHideUser = () => {
        if(confirm(`Bạn có chắc muốn ẩn tin nhắn của ${selectedUser.name}?`)) {
            hiddenUsers.push(selectedUser.uid);
            localStorage.setItem('xingchat_hidden_users', JSON.stringify(hiddenUsers));
            loadCommunityChat(); // Reload to apply filter
            document.getElementById('user-modal').style.display = 'none';
        }
    }

    // --- PRIVATE CHAT ---
    window.searchUser = async (val) => {
        const box = document.getElementById('search-results'); box.innerHTML=""; if(!val) return;
        const d = await getDoc(doc(db,"ids",val.toLowerCase()));
        if(d.exists() && d.data().uid !== me.uid) {
            box.innerHTML = `<div class="chat-item" style="background:#333; color:white;"><b>@${val}</b> <button onclick="addFriend('${d.data().uid}')" style="margin-left:auto; background:var(--app-primary); border:none; padding:5px 10px; border-radius:5px; color:white;">Kết bạn</button></div>`;
        }
    }
    window.addFriend = async (uid) => {
        await updateDoc(doc(db,"users",me.uid),{friends:arrayUnion(uid)});
        await updateDoc(doc(db,"users",uid),{friends:arrayUnion(me.uid)});
        alert("Đã kết bạn!"); loadChatList();
    }
    function loadChatList() {
        onSnapshot(doc(db,"users",me.uid), async(s) => {
            const f = s.data().friends||[]; const l = document.getElementById('chat-list'); l.innerHTML="";
            for(const fid of f) {
                const u = await getDoc(doc(db,"users",fid));
                if(u.exists()) {
                    const el = document.createElement('div'); el.className="chat-item"; el.style.background="#1e1e1e";
                    el.innerHTML=`<img src="https://ui-avatars.com/api/?name=${u.data().displayName}" style="width:40px; height:40px; border-radius:50%;"><div><b>${u.data().displayName}</b></div>`;
                    el.onclick=()=>openChat(fid, u.data().displayName); l.appendChild(el);
                }
            }
        });
    }
    window.openChat = (fid,name) => {
        activeChatID=fid; document.getElementById('chat-window').style.display='flex';
        document.getElementById('cw-name').innerText=name;
        onSnapshot(query(collection(db,"chats",[me.uid,fid].sort().join("_"),"msgs"), orderBy("t","asc")), s=>{
            const b=document.getElementById('cw-msgs'); b.innerHTML="";
            s.forEach(d=>{
                const m=d.data(); const isMe=m.by===me.uid;
                const div=document.createElement('div');
                div.className = `msg-row ${isMe ? 'me' : 'them'}`;
                let contentHTML = `<div class="msg-bubble">${m.txt}</div>`;
                if(m.type==='img') contentHTML = `<img src="${m.txt}" style="max-width:200px; border-radius:15px;">`;
                
                div.innerHTML = contentHTML;
                b.appendChild(div);
            });
            b.scrollTop=b.scrollHeight;
        });
    }
    window.closeChat = () => { document.getElementById('chat-window').style.display='none'; activeChatID=null; }
    window.sendMsg = async () => {
        const t=document.getElementById('cw-inp').value; if(!t||!activeChatID) return;
        await addDoc(collection(db,"chats",[me.uid,activeChatID].sort().join("_"),"msgs"),{by:me.uid,txt:t,type:'text',t:Date.now()});
        document.getElementById('cw-inp').value="";
    }
    window.sendImage = async (inp) => {
        const f=inp.files[0]; if(!f||!activeChatID) return;
        const r=ref(storage,`c/${Date.now()}_${f.name}`); await uploadBytes(r,f);
        await addDoc(collection(db,"chats",[me.uid,activeChatID].sort().join("_"),"msgs"),{by:me.uid,txt:await getDownloadURL(r),type:'img',t:Date.now()});
    }
</script>
</body>
</html>
