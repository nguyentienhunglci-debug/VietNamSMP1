<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XingChat - Fix Final</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* GIỮ NGUYÊN GIAO DIỆN ĐẸP */
        :root {
            --primary: #0084ff;
            --bg-light: #ffffff;
            --text-main: #050505;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: sans-serif; background: #fff; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* UI Components */
        .hidden { display: none !important; }
        .pill-input { width: 100%; padding: 12px 20px; border-radius: 99px; background: #f0f2f5; border: none; outline: none; font-size: 16px; }
        .btn-primary { width: 100%; padding: 15px; border-radius: 99px; background: var(--primary); color: white; border: none; font-weight: bold; font-size: 16px; margin-top: 10px; }
        
        /* Layout */
        .header { height: 60px; padding: 0 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #eee; font-weight: bold; font-size: 18px; }
        .content-area { flex: 1; overflow-y: auto; padding-bottom: 80px; background: white; }
        
        /* Message Bubbles */
        .msg-row { display: flex; gap: 10px; margin-bottom: 10px; padding: 0 10px; }
        .msg-row.me { justify-content: flex-end; }
        .bubble { padding: 10px 15px; border-radius: 20px; max-width: 75%; word-wrap: break-word; font-size: 15px; }
        .me .bubble { background: #0084ff; color: white; }
        .them .bubble { background: #f0f2f5; color: black; }
        
        /* Input Bar */
        .input-bar { position: fixed; bottom: 60px; left: 0; width: 100%; padding: 10px; background: white; border-top: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
        .chat-win-bar { bottom: 0 !important; }

        /* Navigation */
        .nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; border-top: 1px solid #eee; display: flex; background: white; z-index: 99; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #888; font-size: 12px; }
        .nav-item i { font-size: 24px; margin-bottom: 4px; }
        .nav-item.active { color: #0084ff; }

        /* Chat Window */
        #chat-window { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 200; transform: translateX(100%); transition: 0.3s; display: flex; flex-direction: column; }
        #chat-window.open { transform: translateX(0); }

        /* Auth */
        #auth { position: fixed; inset: 0; background: white; z-index: 999; padding: 30px; display: flex; flex-direction: column; justify-content: center; }
    </style>
</head>
<body>

<div id="auth">
    <h2 style="text-align:center; color:#0084ff;">XingChat Login</h2>
    
    <div id="form-login">
        <input id="l-email" class="pill-input" placeholder="Email" style="margin-bottom:10px;">
        <input type="password" id="l-pass" class="pill-input" placeholder="Mật khẩu" style="margin-bottom:10px;">
        <button class="btn-primary" onclick="doLogin()">Đăng nhập</button>
        <p style="text-align:center; margin-top:20px;" onclick="toggleAuth()">Chưa có nick? <b>Đăng ký</b></p>
    </div>

    <div id="form-reg" class="hidden">
        <input id="r-name" class="pill-input" placeholder="Tên hiển thị" style="margin-bottom:10px;">
        <input id="r-id" class="pill-input" placeholder="ID (Vd: tuan123)" style="margin-bottom:10px;">
        <input id="r-email" class="pill-input" placeholder="Email" style="margin-bottom:10px;">
        <input type="password" id="r-pass" class="pill-input" placeholder="Mật khẩu (6+ ký tự)" style="margin-bottom:10px;">
        <button class="btn-primary" onclick="doReg()">Đăng ký</button>
        <p style="text-align:center; margin-top:20px;" onclick="toggleAuth()">Quay lại Đăng nhập</p>
    </div>
</div>

<div id="app" class="hidden">
    
    <div id="tab-1" class="tab-content">
        <div class="header">Cộng đồng <i class="fas fa-globe"></i></div>
        <div id="list-com" class="content-area"></div>
        <div class="input-bar">
            <input id="inp-com" class="pill-input" placeholder="Nhập tin nhắn...">
            <i class="fas fa-paper-plane" style="font-size:24px; color:#0084ff; padding:0 10px;" onclick="sendCom()"></i>
        </div>
    </div>

    <div id="tab-2" class="tab-content hidden">
        <div class="header">Tin nhắn <i class="fas fa-comment-dots"></i></div>
        <div style="padding:10px;">
            <input class="pill-input" placeholder="Tìm ID bạn bè..." onchange="findFriend(this.value)">
            <div id="find-res" style="margin-top:10px; color:#0084ff; font-weight:bold;"></div>
        </div>
        <div id="list-friend" class="content-area"></div>
    </div>

    <div class="nav">
        <div class="nav-item active" onclick="switchTab(1, this)"><i class="fas fa-users"></i>Cộng đồng</div>
        <div class="nav-item" onclick="switchTab(2, this)"><i class="fas fa-comments"></i>Tin nhắn</div>
    </div>
</div>

<div id="chat-window">
    <div class="header">
        <i class="fas fa-arrow-left" onclick="closeChat()"></i>
        <span id="chat-name">User</span>
        <span></span>
    </div>
    <div id="list-msg" class="content-area" style="background:#eef0f3;"></div>
    <div class="input-bar chat-win-bar">
        <input id="inp-msg" class="pill-input" placeholder="Nhắn tin...">
        <i class="fas fa-paper-plane" style="font-size:24px; color:#0084ff; padding:0 10px;" onclick="sendPrivate()"></i>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, addDoc, collection, query, orderBy, onSnapshot, updateDoc, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // CẤU HÌNH CỦA BẠN (ĐÃ FIX CHUẨN)
    const firebaseConfig = {
      apiKey: "AIzaSyAICFb4QrXY2pDzyuf9u-YF9kX5xlaBss0",
      authDomain: "xingchat-13d44.firebaseapp.com",
      projectId: "xingchat-13d44",
      storageBucket: "xingchat-13d44.firebasestorage.app",
      messagingSenderId: "802782197419",
      appId: "1:802782197419:web:91b50dc75ee978fd0aa9ee"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    let me = null;
    let activeChatID = null;

    // --- AUTH ---
    window.toggleAuth = () => {
        document.getElementById('form-login').classList.toggle('hidden');
        document.getElementById('form-reg').classList.toggle('hidden');
    }

    window.doLogin = async () => {
        try {
            await signInWithEmailAndPassword(auth, document.getElementById('l-email').value, document.getElementById('l-pass').value);
        } catch(e) { alert("Lỗi đăng nhập: " + e.message); }
    }

    window.doReg = async () => {
        const id = document.getElementById('r-id').value.toLowerCase().trim();
        const email = document.getElementById('r-email').value;
        const pass = document.getElementById('r-pass').value;
        const name = document.getElementById('r-name').value;

        if(!id || !email || !pass) return alert("Thiếu thông tin!");
        
        try {
            // Check ID
            const check = await getDoc(doc(db, "ids", id));
            if(check.exists()) return alert("ID này đã có người dùng!");

            // Tạo User
            const res = await createUserWithEmailAndPassword(auth, email, pass);
            
            // Lưu data
            await setDoc(doc(db, "users", res.user.uid), {
                uid: res.user.uid,
                displayName: name,
                id: id,
                email: email,
                friends: [],
                avatar: `https://ui-avatars.com/api/?name=${name}&background=random`,
                createdAt: serverTimestamp()
            });
            await setDoc(doc(db, "ids", id), { uid: res.user.uid });
            
            alert("Đăng ký thành công!");
        } catch(e) { alert("Lỗi đăng ký: " + e.message); }
    }

    onAuthStateChanged(auth, async (user) => {
        if(user) {
            const snap = await getDoc(doc(db, "users", user.uid));
            if(snap.exists()) {
                me = snap.data();
                document.getElementById('auth').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                initApp();
            }
        } else {
            document.getElementById('auth').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
        }
    });

    // --- APP LOGIC ---
    function initApp() {
        // Load Cộng đồng
        onSnapshot(query(collection(db, "community_chat"), orderBy("createdAt", "asc")), snap => {
            const list = document.getElementById('list-com'); list.innerHTML = "";
            snap.forEach(d => {
                const m = d.data();
                const isMe = m.uid === me.uid;
                list.innerHTML += `
                    <div class="msg-row ${isMe?'me':'them'}">
                        ${!isMe ? `<img src="${m.avatar}" style="width:30px;height:30px;border-radius:50%">` : ''}
                        <div>
                            ${!isMe ? `<div style="font-size:10px;color:#888">${m.author}</div>` : ''}
                            <div class="bubble">${m.content}</div>
                        </div>
                    </div>`;
            });
            list.scrollTop = list.scrollHeight;
        });

        // Load Friend List
        onSnapshot(doc(db, "users", me.uid), async (s) => {
            const friends = s.data().friends || [];
            const list = document.getElementById('list-friend'); list.innerHTML = "";
            
            for(const fid of friends) {
                const f = await getDoc(doc(db, "users", fid));
                if(f.exists()) {
                    const d = f.data();
                    const div = document.createElement('div');
                    div.style = "padding:15px; border-bottom:1px solid #eee; display:flex; align-items:center; gap:10px; cursor:pointer;";
                    div.innerHTML = `<img src="${d.avatar}" style="width:40px;height:40px;border-radius:50%"> <b>${d.displayName}</b>`;
                    div.onclick = () => openChat(d);
                    list.appendChild(div);
                }
            }
        });
    }

    // --- ACTIONS ---
    window.switchTab = (id, el) => {
        document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden'));
        document.getElementById('tab-'+id).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        el.classList.add('active');
    }

    window.sendCom = async () => {
        const txt = document.getElementById('inp-com').value;
        if(!txt.trim()) return;
        try {
            await addDoc(collection(db, "community_chat"), {
                uid: me.uid, author: me.displayName, avatar: me.avatar, content: txt, createdAt: serverTimestamp()
            });
            document.getElementById('inp-com').value = "";
        } catch(e) { alert("Không gửi được: " + e.message + "\nKiểm tra lại Rules Firebase!"); }
    }

    window.findFriend = async (val) => {
        const id = val.toLowerCase().trim();
        if(!id) return;
        try {
            const d = await getDoc(doc(db, "ids", id));
            if(d.exists()) {
                const uid = d.data().uid;
                if(uid === me.uid) return alert("Đây là nick của bạn!");
                
                // Add Friend logic
                await updateDoc(doc(db, "users", me.uid), { friends: arrayUnion(uid) });
                await updateDoc(doc(db, "users", uid), { friends: arrayUnion(me.uid) });
                
                document.getElementById('find-res').innerText = "Đã kết bạn thành công!";
            } else {
                document.getElementById('find-res').innerText = "Không tìm thấy ID này!";
            }
        } catch(e) { alert("Lỗi kết bạn: " + e.message); }
    }

    // --- PRIVATE CHAT ---
    let unsubChat = null;
    window.openChat = (friend) => {
        activeChatID = [me.uid, friend.uid].sort().join("_");
        document.getElementById('chat-name').innerText = friend.displayName;
        document.getElementById('chat-window').classList.add('open');
        
        if(unsubChat) unsubChat();
        unsubChat = onSnapshot(query(collection(db, "chats", activeChatID, "msgs"), orderBy("createdAt", "asc")), snap => {
            const list = document.getElementById('list-msg'); list.innerHTML = "";
            snap.forEach(d => {
                const m = d.data();
                list.innerHTML += `<div class="msg-row ${m.uid===me.uid?'me':'them'}"><div class="bubble">${m.txt}</div></div>`;
            });
            list.scrollTop = list.scrollHeight;
        });
    }

    window.closeChat = () => {
        document.getElementById('chat-window').classList.remove('open');
        activeChatID = null;
    }

    window.sendPrivate = async () => {
        const txt = document.getElementById('inp-msg').value;
        if(!txt.trim() || !activeChatID) return;
        try {
            await addDoc(collection(db, "chats", activeChatID, "msgs"), {
                uid: me.uid, txt: txt, createdAt: serverTimestamp()
            });
            document.getElementById('inp-msg').value = "";
        } catch(e) { alert("Lỗi gửi tin: " + e.message); }
    }
</script>
</body>
</html>
