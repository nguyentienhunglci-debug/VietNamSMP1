<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tr·ª£ L√Ω C√° Nh√¢n</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="apple-touch-icon" href="icon-192x192.png">

    <style>
        /* --- B·∫¢NG M√ÄU DARK MODE & THI·∫æT K·∫æ M·ªöI --- */
        :root {
            --bg-color: #000000;
            --card-color: #1C1C1E;
            --header-color: #1C1C1E;
            --nav-color: rgba(28, 28, 30, 0.7);
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --accent-blue: #0A84FF;
            --accent-red: #FF453A;
            --accent-green: #30D158;
            --accent-orange: #FF9F0A;
            --border-color: #38383A;
            --input-bg: #2C2C2E;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { color-scheme: dark; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            padding-bottom: 90px;
        }
        .screen { display: none; }
        .screen.active { display: block; }
        .header {
            background: var(--header-color);
            padding: 20px;
            padding-top: 60px; /* Th√™m padding cho status bar tr√™n mobile */
            border-bottom: 1px solid var(--border-color);
        }
        .header h1 { font-size: 34px; font-weight: 700; }
        .btn {
            padding: 15px 20px; border: none; border-radius: 12px;
            font-size: 17px; font-weight: 600; cursor: pointer;
            background: var(--accent-blue); color: white;
            width: 100%; margin-top: 16px;
            transition: transform 0.1s ease, opacity 0.2s ease;
        }
        .btn:active { transform: scale(0.97); opacity: 0.8; }
        .btn-sec { background: #3A3A3C; color: var(--text-primary); }
        .btn-danger { background: var(--accent-red); }
        .btn-success { background: var(--accent-green); }
        .btn-warning { background: var(--accent-orange); }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; padding: 20px; }
        .stat-card { background: var(--card-color); padding: 20px; border-radius: 16px; text-align: center; }
        .stat-label { color: var(--text-secondary); font-size: 14px; margin-bottom: 8px; }
        .stat-value { font-size: 26px; font-weight: 600; }
        .stat-value.red { color: var(--accent-red); }
        .stat-value.green { color: var(--accent-green); }
        .card { background: var(--card-color); border-radius: 16px; padding: 16px; margin: 16px 20px; }
        .card h3 { font-size: 20px; margin-bottom: 16px; }
        .txn-item { display: flex; align-items: center; padding: 12px; background: transparent; border-bottom: 1px solid var(--border-color); }
        .txn-item:last-child { border-bottom: none; }
        .txn-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 16px; }
        .txn-icon.exp { background: rgba(255, 69, 58, 0.3); }
        .txn-icon.inc { background: rgba(48, 209, 88, 0.3); }
        .txn-icon.sav { background: rgba(255, 159, 10, 0.3); }
        .txn-info { flex: 1; }
        .txn-cat { font-weight: 600; font-size: 16px; }
        .txn-date { color: var(--text-secondary); font-size: 14px; }
        .txn-amt { font-weight: 600; font-size: 16px; }
        .txn-acts { display: flex; gap: 8px; margin-left: 8px; }
        .icon-btn { width: 38px; height: 38px; border: none; background: #3A3A3C; border-radius: 50%; cursor: pointer; font-size: 16px; }
        .icon-btn:active { opacity: 0.5; }
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--nav-color);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-color);
            display: flex; padding: 8px 0; padding-bottom: 24px; /* Th√™m padding cho khu v·ª±c an to√†n */
        }
        .nav-item { flex: 1; text-align: center; padding: 8px; cursor: pointer; color: var(--text-secondary); transition: color 0.2s ease; }
        .nav-item.active { color: var(--accent-blue); }
        .nav-item:active { opacity: 0.5; }
        .nav-icon { font-size: 24px; }
        .nav-label { font-size: 11px; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal.show { display: flex; }
        .modal-content { background: #2C2C2E; border-radius: 16px; padding: 24px; width: 90%; max-width: 400px; max-height: 85vh; overflow-y: auto; border: 1px solid var(--border-color); }
        .modal-title { font-size: 22px; font-weight: 600; margin-bottom: 20px; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; color: var(--text-secondary); font-size: 14px; margin-bottom: 8px; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 14px; border: 1px solid var(--border-color); border-radius: 10px; font-size: 16px; background: var(--input-bg); color: var(--text-primary); }
        .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--accent-blue); outline: none; }
        .modal-actions { display: flex; gap: 12px; margin-top: 24px; }
        .empty { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        /* C·∫≠p nh·∫≠t ki·ªÉu cho n√∫t th√™m nhanh */
        .quick-add-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2 c·ªôt */
            gap: 10px;
            margin-top: 12px;
        }
        .quick-add-btn {
            padding: 12px 0;
            border: 1px solid var(--border-color); /* Th√™m vi·ªÅn */
            border-radius: 12px; /* Bo tr√≤n vi·ªÅn */
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            background: var(--input-bg);
            color: var(--accent-blue);
            transition: background-color 0.1s ease;
        }
        .quick-add-btn:active {
            background: #48484A;
        }
        .quick-add-btn.clear {
            grid-column: 1 / -1; /* N√∫t x√≥a chi·∫øm to√†n b·ªô chi·ªÅu r·ªông */
            background: #3A3A3C;
            color: var(--accent-red);
        }
        
        /* --- CSS CHO DANH S√ÅCH & TR√åNH PH√ÅT PHIM --- */
        .phim-item { display: flex; align-items: center; padding: 16px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s; }
        .phim-item:last-child { border-bottom: none; }
        .phim-item:active { background-color: #3A3A3C; }
        .phim-item-num { font-size: 18px; font-weight: bold; color: var(--text-secondary); width: 40px; }
        .phim-item-info { flex-grow: 1; }
        .phim-item-title { font-size: 17px; font-weight: 600; margin-bottom: 4px; }
        .phim-item-desc { font-size: 14px; color: var(--text-secondary); }
        .phim-play-icon { font-size: 24px; color: var(--text-secondary); }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; border-radius: 12px; background: #000; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #moviePlayerModal .modal-content { padding: 12px; }
        #moviePlayerModal .modal-title { padding: 0 12px; margin-top: 12px; margin-bottom: 12px; font-size: 18px; }
        #date-time-container {
            color: var(--text-secondary);
            font-size: 15px;
            margin-top: 4px;
            font-weight: 500;
        }
    </style>
</head>
<body>

<div id="dash" class="screen active">
    <div class="header"><h1>T·ªïng Quan</h1></div>
    <div class="stat-grid">
        <div class="stat-card">
            <div class="stat-label">T·ªïng S·ªë D∆∞</div>
            <div class="stat-value" id="bal">0‚Ç´</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ƒê√£ Chi</div>
            <div class="stat-value red" id="exp">0‚Ç´</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Thu Nh·∫≠p</div>
            <div class="stat-value green" id="inc">0‚Ç´</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Ti·∫øt Ki·ªám</div>
            <div class="stat-value" id="sav">0‚Ç´</div>
        </div>
    </div>
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3>Th√™m Nhanh</h3>
        <button class="btn-sec" onclick="goTo('hist', document.querySelector('.nav-item:nth-child(2)'))" style="padding: 8px 12px; border-radius: 8px; font-size: 14px; margin-top: 0;">Xem t·∫•t c·∫£</button>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 16px;">
            <button class="btn btn-danger" onclick="openTxn('expense')">üí∏ Chi Ti√™u</button>
            <button class="btn btn-success" onclick="openTxn('income')">üí∞ Thu Nh·∫≠p</button>
            <button class="btn btn-warning" onclick="openTxn('savings')">üè¶ Ti·∫øt Ki·ªám</button>
      </div>
    </div>
    <div class="card">
        <h3>Giao D·ªãch G·∫ßn ƒê√¢y</h3>
        <div id="recent"></div>
    </div>
</div>

<div id="hist" class="screen">
    <div class="header"><h1>L·ªãch S·ª≠ Giao D·ªãch</h1></div>
    <div class="card"><input type="text" class="form-input" placeholder="üîç T√¨m ki·∫øm giao d·ªãch..." id="search" oninput="doSearch()"></div>
    <div class="card"><div id="histList"></div></div>
</div>

<div id="notes" class="screen">
    <div class="header">
        <h1>Ghi Ch√∫</h1>
        <button class="btn" onclick="openNote()">+ T·∫°o Ghi Ch√∫ M·ªõi</button>
    </div>
    <div class="card"><div id="notesList"></div></div>
</div>

<div id="movies" class="screen">
    <div class="header">
        <h1>Phim C·ªßa Ph∆∞∆°ng H·ªØu D∆∞·ª°ng</h1>
        <div id="date-time-container">
            <span id="currentDate"></span> | <span id="currentTime"></span>
        </div>
    </div>
    <div class="card" id="phimListContainer">
        </div>
</div>

<div id="settings" class="screen">
    <div class="header"><h1>C√†i ƒê·∫∑t</h1></div>
    <div class="card">
        <h3>Qu·∫£n l√Ω d·ªØ li·ªáu</h3>
        <p style="color: var(--text-secondary); font-size: 14px; margin-top: 8px; margin-bottom: 16px;">H√†nh ƒë·ªông n√†y s·∫Ω x√≥a to√†n b·ªô chi ti√™u v√† ghi ch√∫. Kh√¥ng th·ªÉ ho√†n t√°c.</p>
        <button class="btn btn-danger" onclick="resetData()">X√≥a To√†n B·ªô D·ªØ Li·ªáu</button>
        
        <h3 style="margin-top: 30px;">C·∫≠p nh·∫≠t phi√™n b·∫£n</h3>
        <p style="color: var(--text-secondary); font-size: 14px; margin-top: 8px; margin-bottom: 16px;">Nh·∫•n v√†o ƒë√¢y ƒë·ªÉ t·∫£i l·∫°i trang v√† c·∫≠p nh·∫≠t phi√™n b·∫£n m·ªõi nh·∫•t.</p>
        <button class="btn btn-sec" onclick="reloadApp()">C·∫≠p nh·∫≠t Phi√™n b·∫£n M·ªõi</button>
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="goTo('dash', this)"><div class="nav-icon">üè†</div><div class="nav-label">T·ªïng Quan</div></div>
    <div class="nav-item" onclick="goTo('hist', this)"><div class="nav-icon">üìä</div><div class="nav-label">L·ªãch S·ª≠</div></div>
    <div class="nav-item" onclick="goTo('notes', this)"><div class="nav-icon">üìù</div><div class="nav-label">Ghi Ch√∫</div></div>
    <div class="nav-item" onclick="goTo('movies', this)"><div class="nav-icon">üé¨</div><div class="nav-label">Phim</div></div>
    <div class="nav-item" onclick="goTo('settings', this)"><div class="nav-icon">‚öôÔ∏è</div><div class="nav-label">C√†i ƒê·∫∑t</div></div>
</div>

<div id="txnModal" class="modal"><div class="modal-content">
    <h2 class="modal-title" id="modalTitle"></h2>
    <div class="form-group">
        <label class="form-label">S·ªë ti·ªÅn (‚Ç´)</label>
        <input type="number" class="form-input" id="amt" placeholder="50000" inputmode="numeric">
        <div class="quick-add-grid">
            <button type="button" class="quick-add-btn" onclick="addAmount(10000)">+ 10.000‚Ç´</button>
            <button type="button" class="quick-add-btn" onclick="addAmount(20000)">+ 20.000‚Ç´</button>
            <button type="button" class="quick-add-btn" onclick="addAmount(50000)">+ 50.000‚Ç´</button>
            <button type="button" class="quick-add-btn" onclick="addAmount(100000)">+ 100.000‚Ç´</button>
            <button type="button" class="quick-add-btn" onclick="addAmount(200000)">+ 200.000‚Ç´</button>
            <button type="button" class="quick-add-btn" onclick="addAmount(500000)">+ 500.000‚Ç´</button>
            <button type="button" class="quick-add-btn clear" onclick="clearAmount()">X√≥a</button>
        </div>
    </div>
    <div class="form-group">
        <label class="form-label">Danh m·ª•c</label>
        <select class="form-select" id="cat">
            <option value="food">üçî ƒÇn u·ªëng</option><option value="transport">üöó ƒêi l·∫°i</option><option value="shopping">üõçÔ∏è Mua s·∫Øm</option><option value="bills">üí° H√≥a ƒë∆°n</option><option value="salary">üí∞ L∆∞∆°ng</option><option value="other">üìå Kh√°c</option>
        </select>
    </div>
    <div class="form-group"><label class="form-label">Ghi ch√∫</label><textarea class="form-textarea" id="note"></textarea></div>
    <input type="hidden" id="type"><input type="hidden" id="editId">
    <div class="modal-actions"><button class="btn btn-sec" onclick="closeModal('txnModal')" style="flex:1">H·ªßy</button><button class="btn" onclick="saveTxn()" style="flex:1">L∆∞u</button></div>
</div></div>
<div id="noteModal" class="modal"><div class="modal-content">
    <h2 class="modal-title">Ghi Ch√∫</h2>
    <div class="form-group"><label class="form-label">Ti√™u ƒë·ªÅ</label><input type="text" class="form-input" id="noteTitle"></div>
    <div class="form-group"><label class="form-label">N·ªôi dung</label><textarea class="form-textarea" id="noteContent" style="min-height:200px"></textarea></div>
    <input type="hidden" id="editNoteId">
    <div class="modal-actions"><button class="btn btn-sec" onclick="closeModal('noteModal')" style="flex:1">H·ªßy</button><button class="btn" onclick="saveNote()" style="flex:1">L∆∞u</button></div>
</div></div>
<div id="moviePlayerModal" class="modal"><div class="modal-content">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2 class="modal-title" id="moviePlayerTitle"></h2>
        <button onclick="closeModal('moviePlayerModal')" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">&times;</button>
    </div>
    <div class="video-container"><iframe id="youtubePlayer" src="" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div>
</div></div>

<script>
const OLD_KEY_V2 = 'mywallet_dark_v2';
const OLD_KEY_V3 = 'mywallet_dark_v3';
const CURRENT_KEY = 'mywallet_dark_v4'; // Kh√≥a l∆∞u tr·ªØ cho phi√™n b·∫£n hi·ªán t·∫°i

let db = { txns: [], notes: [] };

// --- DANH S√ÅCH PHIM M·ªöI C·ª¶A PH∆Ø∆†NG H·ªÆU D∆Ø·ª†NG (CH·ªà C√ì 1 PHIM B·∫†N Y√äU C·∫¶U) ---
const phuongHuuDuongMovies = [
    { id: 1, title: "PHD - Th·ª≠ Th√°ch Ng∆∞·ªùi Cu·ªëi C√πng Kh√¥ng Ng·ªß T·∫≠p 3", desc: "Th·ª≠ th√°ch ng∆∞·ªùi cu·ªëi c√πng kh√¥ng ng·ªß", youtubeId: "8HJFIgI2oPE" }
];

function migrateData() {
    const currentData = localStorage.getItem(CURRENT_KEY);
    if (currentData) return; // N·∫øu ƒë√£ c√≥ d·ªØ li·ªáu m·ªõi th√¨ kh√¥ng l√†m g√¨ c·∫£

    const oldDataV3 = localStorage.getItem(OLD_KEY_V3);
    if (oldDataV3) {
        console.log("Migrating data from v3 to v4...");
        localStorage.setItem(CURRENT_KEY, oldDataV3);
        localStorage.removeItem(OLD_KEY_V3);
        return;
    }
    
    const oldDataV2 = localStorage.getItem(OLD_KEY_V2);
    if (oldDataV2) {
        console.log("Migrating data from v2 to v4...");
        localStorage.setItem(CURRENT_KEY, oldDataV2);
        localStorage.removeItem(OLD_KEY_V2);
        return;
    }
}

function load() {
    try { 
        const s = localStorage.getItem(CURRENT_KEY); 
        if (s) db = JSON.parse(s); 
    } catch(e) {}
}

function save() { 
    localStorage.setItem(CURRENT_KEY, JSON.stringify(db)); 
}

function fmt(n) { return new Intl.NumberFormat('vi-VN').format(n) + '‚Ç´'; }

function updateClock() {
    const now = new Date();
    const dateString = now.toLocaleDateString('vi-VN', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
    const timeString = now.toLocaleTimeString('vi-VN');
    document.getElementById('currentDate').textContent = dateString.charAt(0).toUpperCase() + dateString.slice(1);
    document.getElementById('currentTime').textContent = timeString;
}

function init() {
    migrateData(); // Ch·∫°y h√†m chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu tr∆∞·ªõc khi t·∫£i
    load();
    updateClock();
    setInterval(updateClock, 1000); 
    render();
}

function render() {
    renderDash();
    renderHist();
    renderNotes();
    renderPhimList();
}

// C√°c h√†m render ch√≠nh
function renderDash() {
    let bal = 0, exp = 0, inc = 0, sav = 0;
    db.txns.forEach(t => {
        if (t.type === 'expense') exp += t.amount;
        else if (t.type === 'income') inc += t.amount;
        else if (t.type === 'savings') sav += t.amount;
    });
    bal = inc - exp;
    
    document.getElementById('bal').textContent = fmt(bal);
    document.getElementById('exp').textContent = fmt(exp);
    document.getElementById('inc').textContent = fmt(inc);
    document.getElementById('sav').textContent = fmt(sav);
    
    const recent = db.txns.slice().reverse().slice(0, 3);
    document.getElementById('recent').innerHTML = recent.length ? recent.map(t => makeTxn(t, false)).join('') : '<div class="empty">Ch∆∞a c√≥ giao d·ªãch.</div>';
}
function renderHist() {
    const allTxns = db.txns.slice().reverse();
    document.getElementById('histList').innerHTML = allTxns.length ? allTxns.map(t => makeTxn(t, true)).join('') : '<div class="empty">Kh√¥ng c√≥ giao d·ªãch n√†o.</div>';
}
function renderNotes() {
    const allNotes = db.notes.slice().reverse();
    document.getElementById('notesList').innerHTML = allNotes.length > 0 ? allNotes.map(n => `<div class="phim-item" onclick="editNote(${n.id})"><div class="phim-item-info"><div class="phim-item-title">${n.title}</div><div class="phim-item-desc">${n.content.substring(0,100)}...</div></div></div>`).join('') : '<div class="empty">Ch∆∞a c√≥ ghi ch√∫ n√†o.</div>';
}
function renderPhimList() {
    document.getElementById('phimListContainer').innerHTML = phuongHuuDuongMovies.map(movie => `
        <div class="phim-item" onclick="openMoviePlayer('${movie.youtubeId}', '${movie.title.replace(/'/g, "\\'")}')">
            <div class="phim-item-num">${movie.id.toString().padStart(2, '0')}</div>
            <div class="phim-item-info">
                <div class="phim-item-title">${movie.title}</div>
                <div class="phim-item-desc">${movie.desc}</div>
            </div>
            <div class="phim-play-icon">‚ñ∂</div>
        </div>
    `).join('');
}


// H√†m t·∫°o HTML
function makeTxn(t, acts) {
    const icons = { food: 'üçî', transport: 'üöó', shopping: 'üõçÔ∏è', bills: 'üí°', salary: 'üí∞', other: 'üìå' };
    const names = { food: 'ƒÇn u·ªëng', transport: 'ƒêi l·∫°i', shopping: 'Mua s·∫Øm', bills: 'H√≥a ƒë∆°n', salary: 'L∆∞∆°ng', other: 'Kh√°c' };
    const cls = t.type === 'expense' ? 'exp' : (t.type === 'income' ? 'inc' : 'sav');
    const amtSign = t.type === 'expense' ? '-' : '+';
    const amtColor = t.type === 'expense' ? 'var(--accent-red)' : 'var(--accent-green)';
    const btns = acts ? `<div class="txn-acts"><button class="icon-btn" onclick="event.stopPropagation(); editTxn(${t.id})">‚úèÔ∏è</button><button class="icon-btn" onclick="event.stopPropagation(); delTxn(${t.id})">üóëÔ∏è</button></div>` : '';
    return `<div class="txn-item"><div class="txn-icon ${cls}">${icons[t.cat]||'üìå'}</div><div class="txn-info"><div class="txn-cat">${names[t.cat]||'Kh√°c'}</div><div class="txn-date">${new Date(t.date).toLocaleDateString('vi-VN')}</div></div><div class="txn-amt" style="color:${amtColor}">${amtSign}${fmt(t.amount)}</div>${btns}</div>`;
}

// H√†m ƒëi·ªÅu h∆∞·ªõng
function goTo(scr, element) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById(scr).classList.add('active');
    element.classList.add('active');
}

// H√†m t∆∞∆°ng t√°c Modal
function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) {
    const modal = document.getElementById(id);
    modal.classList.remove('show');
    if (id === 'moviePlayerModal') {
        document.getElementById('youtubePlayer').src = ''; // D·ª´ng video khi ƒë√≥ng
    }
}

// H√†m cho Phim
function openMoviePlayer(youtubeId, title) {
    document.getElementById('youtubePlayer').src = `https://www.youtube.com/embed/${youtubeId}?autoplay=1`;
    document.getElementById('moviePlayerTitle').textContent = title;
    openModal('moviePlayerModal');
}

// H√†m cho Giao d·ªãch
function openTxn(txnType) {
    document.getElementById('editId').value = '';
    document.getElementById('amt').value = '';
    document.getElementById('cat').value = 'food';
    document.getElementById('note').value = '';
    document.getElementById('type').value = txnType;
    const titles = {'expense':'üí∏ Chi Ti√™u M·ªõi','income':'üí∞ Thu Nh·∫≠p M·ªõi','savings':'üè¶ Ti·∫øt Ki·ªám M·ªõi'};
    document.getElementById('modalTitle').textContent = titles[txnType];
    openModal('txnModal');
}
function saveTxn() {
    const id = document.getElementById('editId').value;
    const amt = parseInt(document.getElementById('amt').value) || 0;
    if (amt <= 0) { alert('Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá!'); return; }
    const txn = {id: id ? parseInt(id) : Date.now(), type: document.getElementById('type').value, amount: amt, cat: document.getElementById('cat').value, note: document.getElementById('note').value, date: id ? db.txns.find(t=>t.id === parseInt(id)).date : new Date().toISOString()};
    if (id) { const idx = db.txns.findIndex(t => t.id === parseInt(id)); if (idx > -1) db.txns[idx] = txn; } else { db.txns.push(txn); }
    save(); closeModal('txnModal'); render();
}
function editTxn(id) { const t = db.txns.find(x => x.id === id); if (!t) return; openTxn(t.type); document.getElementById('editId').value = t.id; document.getElementById('amt').value = t.amount; document.getElementById('cat').value = t.cat; document.getElementById('note').value = t.note; }
function delTxn(id) { if (confirm('X√≥a giao d·ªãch n√†y?')) { db.txns = db.txns.filter(t => t.id !== id); save(); render(); }}
function addAmount(value) { const i = document.getElementById('amt'); i.value = (parseInt(i.value)||0) + value; }
function clearAmount() { document.getElementById('amt').value = ''; }

// H√†m cho Ghi ch√∫
function openNote() { document.getElementById('editNoteId').value = ''; document.getElementById('noteTitle').value = ''; document.getElementById('noteContent').value = ''; openModal('noteModal'); }
function saveNote() {
    const title = document.getElementById('noteTitle').value.trim();
    if (!title) { alert('Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ!'); return; }
    const id = document.getElementById('editNoteId').value;
    const n = {id: id ? parseInt(id) : Date.now(), title, content: document.getElementById('noteContent').value.trim(), date: id ? db.notes.find(x => x.id === parseInt(id)).date : new Date().toISOString()};
    if (id) { const idx = db.notes.findIndex(x => x.id === parseInt(id)); if (idx > -1) db.notes[idx] = n; } else { db.notes.push(n); }
    save(); closeModal('noteModal'); render();
}
function editNote(id) { const n = db.notes.find(x => x.id === id); if (!n) return; openNote(); document.getElementById('editNoteId').value = n.id; document.getElementById('noteTitle').value = n.title; document.getElementById('noteContent').value = n.content; }

// H√†m t√¨m ki·∫øm v√† c√†i ƒë·∫∑t
function doSearch() {
    const q = document.getElementById('search').value.toLowerCase();
    const res = db.txns.slice().reverse().filter(t => t.note.toLowerCase().includes(q) || t.amount.toString().includes(q) || t.cat.toLowerCase().includes(q));
    document.getElementById('histList').innerHTML = res.length > 0 ? res.map(t => makeTxn(t, true)).join('') : '<div class="empty">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£.</div>';
}
function resetData() {
    if (confirm('‚ö†Ô∏è B·∫†N C√ì CH·∫ÆC CH·∫ÆN MU·ªêN X√ìA TO√ÄN B·ªò D·ªÆ LI·ªÜU?\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
        db = { txns: [], notes: [] }; save(); render(); alert('‚úÖ ƒê√£ x√≥a to√†n b·ªô d·ªØ li·ªáu.');
    }
}

function reloadApp() {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën c·∫≠p nh·∫≠t phi√™n b·∫£n m·ªõi? Trang s·∫Ω t·∫£i l·∫°i.')) {
        location.reload(true); // T·∫£i l·∫°i trang t·ª´ server, b·ªè qua b·ªô nh·ªõ cache
    }
}

init();
</script>
</body>
</html>
